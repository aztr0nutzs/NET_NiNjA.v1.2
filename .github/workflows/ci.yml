name: CI

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'web-ui/**'
      - '.github/**'
      - 'docker-compose.yml'
  pull_request:
    branches: [ main ]

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build (server)
        run: ./gradlew :server:build --no-daemon

      - name: Run server unit tests
        run: ./gradlew :server:test --no-daemon

  lint-ui:
    runs-on: ubuntu-latest
    needs: build-server
    steps:
      - uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install & lint (if configured)
        working-directory: web-ui
        run: |
          if [ -f package.json ]; then
            npm ci
            if npm run | grep -q lint; then
              npm run lint
            fi
          else
            echo "No web-ui package.json; skipping JS lint"
          fi

  smoke-integration:
    runs-on: ubuntu-latest
    needs: [build-server]
    steps:
      - uses: actions/checkout@v4

      - name: Start server and smoke test
        run: |
          # Build server jar (already built in build-server, but ensure)
          ./gradlew :server:build --no-daemon
          # Find jar
          JAR=$(ls server/build/libs | grep '\.jar$' | head -n1)
          echo "Starting jar: $JAR"
          nohup java -jar server/build/libs/$JAR &>/tmp/netninja.log &
          sleep 3
          echo "Waiting for server to accept connections..."
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8787/api/v1/system/info || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Server up"
              break
            fi
            sleep 1
          done
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Server not responding; dumping server log"
            tail -n 200 /tmp/netninja.log || true
            exit 1
          fi
          echo "Smoke test OK"
