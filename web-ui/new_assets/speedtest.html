<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>NEONLINK // Speedtest HUD</title>

  <!-- Keep your base theme if you want. (This is your original app stylesheet, not the cyber button one.) -->
  <link rel="stylesheet" href="style.css" />

  <style id="theme-overrides">
    :root{
      --primary-color: #00ebff;      /* cyan */
      --secondary-color: #ffae00;    /* amber */
      --green-color: #00ebff;        /* kill any "green" usage */
      --price-color: var(--secondary-color);
      --shadow-color: rgba(0,0,0,0); /* no glow */
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* neon purple borders */
      --border-neon: rgba(70, 255, 210, 0.55);
      --border-soft: rgba(70, 255, 210, 0.24);
      --border-hair: rgba(70, 255, 210, 0.12);
    }

    /* Hard kill: glow/shadow/filter everywhere */
    *{
      text-shadow: none !important;
      box-shadow: none !important;
      filter: none !important;
      -webkit-filter: none !important;
    }

    html, body{
      background: #000 !important;
      background-image: none !important;
      margin: 0;
    }

    body{
      color: rgba(230,251,255,.92);
      padding: 1.2rem !important;
      overflow-x: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @media (min-width: 721px){
      body{ padding: 2rem !important; }
    }

    .fx-grid, .fx-scan, .glow, .neon, .scanlines, .grid-overlay{
      display: none !important;
      opacity: 0 !important;
      background: none !important;
    }

    /* Neon purple borders everywhere (no cyan borders) */
    .header-video,
    .topbar-inner,
    .pill,
    .card,
    .hud,
    .hud-item,
    .select,
    .toggle,
    .chart canvas{
      border-color: var(--border-neon) !important;
    }
    .card-header{
      border-bottom-color: var(--border-hair) !important;
    }
    .signalbar{
      border-color: var(--border-soft) !important;
    }

    /* Header MP4 */
    .header-video{
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 1500px;
      margin: 0 auto 1.2rem auto;
      border: 1px solid var(--border-hair);
      background: #000;
      overflow: hidden;
    }
    .header-video video{
      width: 100%;
      height: auto;
      display: block;
      background: #000;
    }

    /* App layout */
    .app{ position: relative; z-index: 1; max-width: 1500px; margin: 0 auto; }

    .topbar{ margin-bottom: 1.1rem; }
    .topbar-inner{
      display:flex;
      align-items:center;
      gap: 1rem;
      flex-wrap:wrap;
      padding: 1.2rem 1.4rem;
      background: rgba(0,0,0,.70);
      border: 1px solid var(--border-neon);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 1rem;
      flex: 1 1 auto;
      min-width: 240px;
    }
    .brand h1{
      margin:0;
      font-size: 1.35rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--primary-color);
      line-height: 1.1;
    }
    .brand .sub{
      margin-top:.35rem;
      font-size: 1.0rem;
      letter-spacing:.08em;
      opacity:.75;
      text-transform:uppercase;
    }

    .pill{
      display:flex; align-items:center; gap:.8rem;
      padding:.8rem 1rem;
      border: 1px solid var(--border-hair);
      background: rgba(0,0,0,.45);
      text-transform:uppercase;
      font-size: 1.05rem;
      margin-left: auto;
      flex: 0 0 auto;
    }
    .pill .dot{
      width:10px;height:10px;border-radius: 99px;
      background: var(--secondary-color);
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse{ 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(.72);opacity:.65} }

    .shell{
      display:grid;
      grid-template-columns: 1.55fr .95fr;
      gap: 1.4rem;
      align-items:start;
    }
    @media (max-width: 980px){ .shell{ grid-template-columns:1fr; } }

    .card{
      background: rgba(0,0,0,.55);
      border: 1px solid var(--border-hair);
      padding: 0;
    }
    .card-header{
      background: rgba(0,0,0,.70);
      padding: 1.2rem 1.4rem;
      border-bottom: 1px solid var(--border-hair);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:1rem;
    }
    .title{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: var(--primary-color);
    }
    .meta{
      font-size:1.0rem;
      opacity:.75;
      text-transform:uppercase;
      letter-spacing:.08em;
      display:flex;
      gap: 1rem;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .meta b{ color:#fff; font-weight:700; }

    /* ============================================================
       CYBERPUNK BUTTONS (AND FIX SO THEY ACTUALLY APPEAR)
       ============================================================ */

    .cybr-btn, .cybr-btn__glitch {
      font-family: 'Cyber', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .cybr-btn {
      --primary: hsl(var(--primary-hue), 85%, calc(var(--primary-lightness, 50) * 1%));
      --shadow-primary: hsl(var(--shadow-primary-hue), 90%, 50%);
      --primary-hue: 180;
      --primary-lightness: 50;
      --color: hsl(0, 0%, 0%);
      --font-size: 0.82em;
      --shadow-primary-hue: 300;
      --shadow-secondary-hue: 60;
      --shadow-secondary: hsl(var(--shadow-secondary-hue), 90%, 60%);
      --clip: polygon(0 0, 100% 0, 100% 100%, 85% 100%, 8% 100%, 0 70%);
      --border: 0.28em;
      --shimmy-distance: 5;
      --clip-one: polygon(0 2%, 100% 2%, 100% 95%, 8% 95%, 0 70%);
      --clip-two: polygon(0 78%, 100% 78%, 100% 100%, 8% 100%, 0 78%);
      --clip-three: polygon(0 44%, 100% 44%, 100% 54%, 8% 54%, 0 54%);
      --clip-four: polygon(0 0, 100% 0, 100% 0, 8% 0, 0 0);
      --clip-five: polygon(0 0, 100% 0, 100% 0, 8% 0, 0 0);
      --clip-six: polygon(0 40%, 100% 40%, 100% 85%, 8% 85%, 0 70%);
      --clip-seven: polygon(0 63%, 100% 63%, 100% 80%, 8% 80%, 0 70%);

      color: var(--color);
      cursor: pointer;
      background: transparent;
      text-transform: uppercase;
      font-size: var(--font-size);
      outline: transparent;
      letter-spacing: 2px;
      position: relative;
      font-weight: 700;
      border: 0;
      height: 2.75em;
      line-height: 2.85;
      transition: background 0.2s;
      padding: 0;
      user-select: none;
      -webkit-tap-highlight-color: transparent;

      z-index: 0;
      isolation: isolate;
      display: inline-block;
      width: 13.9em;
    }

    .cybr-btn:hover { --primary: hsl(var(--primary-hue), 85%, calc(var(--primary-lightness, 50) * 0.8%)); }
    .cybr-btn:active { --primary: hsl(var(--primary-hue), 85%, calc(var(--primary-lightness, 50) * 0.6%)); }

    .cybr-btn:after,
    .cybr-btn:before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      clip-path: var(--clip);
      z-index: -1;
    }
    .cybr-btn:before {
      background: var(--shadow-primary);
      transform: translate(var(--border), 0);
    }
    .cybr-btn:after { background: var(--primary); }

    .cybr-btn__glitch {
      position: absolute;
      top: calc(var(--border) * -1);
      left: calc(var(--border) * -1);
      right: calc(var(--border) * -1);
      bottom: calc(var(--border) * -1);
      background: var(--shadow-primary);
      text-shadow: 2px 2px var(--shadow-primary), -2px -2px var(--shadow-secondary);
      clip-path: var(--clip);
      animation: glitch 2s infinite;
      display: none;
      color: #fff;
      line-height: 2.85;
      pointer-events: none;
    }
    .cybr-btn:hover .cybr-btn__glitch { display: block; }
    .cybr-btn__glitch:before {
      content: '';
      position: absolute;
      top: calc(var(--border) * 1);
      right: calc(var(--border) * 1);
      bottom: calc(var(--border) * 1);
      left: calc(var(--border) * 1);
      clip-path: var(--clip);
      background: var(--primary);
      z-index: -1;
    }

    @keyframes glitch {
      0% { clip-path: var(--clip-one); }
      2%, 8% { clip-path: var(--clip-two); transform: translate(calc(var(--shimmy-distance) * -1%), 0); }
      6% { clip-path: var(--clip-two); transform: translate(calc(var(--shimmy-distance) * 1%), 0); }
      9% { clip-path: var(--clip-two); transform: translate(0, 0); }
      10% { clip-path: var(--clip-three); transform: translate(calc(var(--shimmy-distance) * 1%), 0); }
      13% { clip-path: var(--clip-three); transform: translate(0, 0); }
      14%, 21% { clip-path: var(--clip-four); transform: translate(calc(var(--shimmy-distance) * 1%), 0); }
      25% { clip-path: var(--clip-five); transform: translate(calc(var(--shimmy-distance) * 1%), 0); }
      30% { clip-path: var(--clip-five); transform: translate(calc(var(--shimmy-distance) * -1%), 0); }
      35%, 45% { clip-path: var(--clip-six); transform: translate(calc(var(--shimmy-distance) * -1%)); }
      40% { clip-path: var(--clip-six); transform: translate(calc(var(--shimmy-distance) * 1%)); }
      50% { clip-path: var(--clip-six); transform: translate(0, 0); }
      55% { clip-path: var(--clip-seven); transform: translate(calc(var(--shimmy-distance) * 1%), 0); }
      60% { clip-path: var(--clip-seven); transform: translate(0, 0); }
      31%, 61%, 100% { clip-path: var(--clip-four); }
    }

    .cybr-btn:disabled{
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }
    .cybr-btn:disabled .cybr-btn__glitch{ display:none !important; }

    .controls{
      padding: 1.2rem 1.4rem 1.4rem;
      display:flex;
      flex-direction:column;
      gap: 1.05rem;
      border-bottom: 1px solid var(--border-hair);
      background: rgba(0,0,0,.45);
    }

    /* Top row: buttons on the left, run.mp4 on the right */
    .controls-top{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(120px, 180px);
      gap: 1.05rem 1.2rem;
      align-items:start;
    }

    .controls-buttons{
      display:flex;
      flex-direction:column;
      gap: .95rem;
      min-width: 0;
    }

    /* Make cyber buttons actually fill the column */
    .controls-buttons .cybr-btn{
      width: 100%;
      max-width: none;
    }

    .controls-media{
      display:flex;
      justify-content:flex-end;
      align-items:stretch;
      min-width: 0;
    }

    .runpanel{
      width: 100%;
      border: 1px solid var(--border-soft);
      background: #000;
      overflow: hidden;
      max-width: 240px;
      /* Match the stacked button column height so it reads as a true right-side panel */
      height: calc(2.75em * 3 + .95rem * 2);
    }
    .runpanel video{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      background:#000;
    }

    /* Bottom row: selects/toggles flow naturally */
    .controls-bottom{
      display:flex;
      flex-wrap:wrap;
      gap: 1.05rem 1.2rem;
      align-items:center;
    }

    /* Keep run.mp4 ALWAYS to the right of the 3 buttons (no stacking). On very narrow screens, just shrink the right column. */
    @media (max-width: 420px){
      .controls-top{ grid-template-columns: minmax(0,1fr) 130px; gap: .85rem .9rem; }
      .controls-media{ justify-content: flex-end; }
      .runpanel{ max-width: 130px; height: calc(2.75em * 3 + .95rem * 2); }
    }
    }

    .select, .toggle{
      display:flex;
      align-items:center;
      gap:.8rem;
      padding: .9rem 1.1rem;
      border: 1px solid var(--border-hair);
      background: rgba(0,0,0,.45);
    }
    .select label, .toggle label{
      font-size:1.0rem;
      opacity:.75;
      text-transform:uppercase;
      letter-spacing:.14em;
    }
    select{
      background: transparent;
      border: none;
      color: #fff;
      outline: none;
      font-size: 1.05rem;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .switch{
      width: 44px; height: 22px;
      border: 1px solid var(--border-hair);
      background: rgba(0,0,0,.55);
      position:relative;
    }
    .switch:after{
      content:"";
      position:absolute; top:2px; left:2px;
      width:18px; height:18px;
      background: rgba(0,235,255,.75);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on:after{ transform: translateX(20px); background: rgba(255,174,0,.75); }

    .gauge-wrap{
  padding: .6rem .8rem 1rem;
  display:grid;
  grid-template-columns: 2.6fr .45fr;   /* BIGGER GAUGE */
  gap: .8rem;
  align-items:start;
}
    @media (max-width: 1120px){
      .gauge-wrap{ grid-template-columns: 1fr; }
      .hud{ order: 2; }
    }

    .gauge{
  position: relative;
  border-radius: 22px;
  padding: 0;                 /* REMOVE INNER SHRINK */
  background:
    url("gauge_bg_clean.png") center top / contain no-repeat,
    #000 !important;
  border: none !important;
  overflow: hidden;
  width: 100%;
}

    #gaugeCanvas{
  width: 100%;
  height: auto;
  aspect-ratio: 1600 / 720;   /* TALLER = BIGGER GAUGE */
  display:block;
  background: transparent !important;
}

    @media (max-width: 720px){
      body{ padding: .8rem !important; }
      .topbar-inner{ padding: 1.0rem 1.0rem; }
      .controls{ padding: 1.0rem 1.0rem 1.1rem; gap: 1.0rem; }
      .gauge-wrap{ padding: .75rem .75rem 1.0rem; }
      .gauge{ padding: 0; border-radius: 16px; }
      #gaugeCanvas{ aspect-ratio: 1600 / 760; }
    }

    .gauge-overlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .gauge-center-readout{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .gauge-center-speed{
      font-family: var(--mono);
      font-weight: 900;
      font-size: clamp(18px, 3.6vw, 44px);
      color: rgba(230,251,255,.92);
      letter-spacing: 0.02em;
      line-height: 1.0;
    }

    .gauge-bottom-readout{
      position: absolute;
      left: 0;
      right: 0;
      top: 77%;
      height: 18%;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      align-items: center;
      padding: 0 8%;
    }
    .gauge-slot{ text-align: center; }
    .gauge-slot-val{
      font-family: var(--mono);
      font-weight: 900;
      font-size: clamp(13px, 2.4vw, 24px);
      color: rgba(230,251,255,.92);
      letter-spacing: 0.02em;
      line-height: 1.0;
    }

    .readout{ display:none !important; }

    .hud{
      border: 1px solid var(--border-hair);
      background: rgba(0,0,0,.55);
      padding: 1.1rem;
    }
    .hud-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .hud-item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.45);
      padding: 1rem;
      min-height: 90px;
    }
    .hud-k{
      font-size: 1.0rem;
      opacity:.75;
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .hud-v{
      margin-top:.8rem;
      font-size: 2.4rem;
      color:#fff;
      letter-spacing:.06em;
      line-height:1.1;
    }
    .hud-v small{
      font-size: 1.05rem;
      opacity:.7;
      text-transform:uppercase;
      letter-spacing:.14em;
    }
    .hud-wide{
      grid-column: 1 / -1;
      min-height: 110px;
      display:flex;
      flex-direction:column;
      gap:.8rem;
    }

    .signalbar{
      height: 10px;
      border: 1px solid rgba(255,174,0,.18);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      position:relative;
    }
    .signalbar > i{
      position:absolute; inset:0;
      width:42%;
      background: linear-gradient(90deg, rgba(0,235,255,.60), rgba(255,174,0,.60));
      transition: width .18s ease;
    }

    .side{ display:flex; flex-direction:column; gap: 1.4rem; }
    .list{ padding: 1.2rem 1.4rem 1.4rem; display:flex; flex-direction:column; gap: 1.1rem; background: rgba(0,0,0,.45); }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap: 1rem;
      font-size: 1.0rem; opacity:.8; text-transform:uppercase; letter-spacing:.10em;
    }
    .row b{ color:#fff; opacity:1; font-weight:700; }
    .tag{
      padding: .6rem 1rem;
      border: 1px solid var(--border-hair);
      background: rgba(0,0,0,.50);
      display:flex; align-items:center; gap:.8rem;
      font-size: 1.0rem;
    }
    .tag i{ width:8px; height:8px; border-radius:99px; background: var(--primary-color); display:inline-block; }
    .tag.warn{ border-color: rgba(255,174,0,.22); }
    .tag.warn i{ background: var(--secondary-color); }
    .tag.bad{ border-color: rgba(255,47,77,.22); }
    .tag.bad i{ background: rgba(255,47,77,.85); }
    .tag.good{ border-color: rgba(0,235,255,.22); }
    .tag.good i{ background: var(--primary-color); }

    .chart{ padding: 1.2rem 1.4rem 1.4rem; background: rgba(0,0,0,.45); }
    .chart canvas{
      width:100%;
      height: 210px;
      display:block;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--border-hair);
    }

    .footer{
      margin-top: 1.4rem;
      padding: 1.2rem 0 0;
      border-top: 1px solid var(--border-hair);
      display:flex; justify-content:space-between; gap: 1rem; flex-wrap:wrap;
      font-size: 1.0rem; text-transform:uppercase; letter-spacing:.10em; opacity:.75;
      align-items:center;
    }
  </style>
</head>

<body>
  <!-- Header MP4 -->
  <div class="header-video">
    <video id="headerMp4" autoplay muted loop playsinline preload="auto">
      <source src="header.mp4" type="video/mp4">
    </video>
  </div>

  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div>
            <h1>NEONLINK // SPEEDTEST HUD</h1>
            <div class="sub">Holographic diagnostic console • pure black</div>
          </div>
        </div>

        <div class="pill" title="Network state (UI-only)">
          <div class="dot"></div>
          <span id="netState">LINK: STABLE • RF: NOMINAL</span>
        </div>
      </div>
    </header>

    <main class="shell">
      <!-- MAIN PANEL -->
      <section class="card">
        <div class="card-header">
          <h2 class="title">Speedometer core</h2>
          <div class="meta">
            <span>Server: <b id="serverName">NEO-1</b></span>
            <span>Mode: <b id="modeLabel">AUTO</b></span>
          </div>
        </div>

        <div class="controls">
          <div class="controls-top">
            <div class="controls-buttons">
              <button class="cybr-btn" id="btnStart" type="button">
                START TEST
                <span aria-hidden="true" class="cybr-btn__glitch">START TEST</span>
              </button>

              <button class="cybr-btn" id="btnAbort" type="button" disabled>
                ABORT
                <span aria-hidden="true" class="cybr-btn__glitch">ABORT</span>
              </button>

              <button class="cybr-btn" id="btnReset" type="button">
                RESET
                <span aria-hidden="true" class="cybr-btn__glitch">RESET</span>
              </button>
            </div>

            <!-- run.mp4 moved here (right-side panel next to the buttons, like your red box) -->
            <div class="controls-media" aria-label="Run animation panel">
              <div class="runpanel">
                <video id="runMp4" autoplay muted loop playsinline preload="auto">
                  <source src="run.mp4" type="video/mp4">
                </video>
              </div>
            </div>
          </div>

          <div class="controls-bottom">
            <div class="select">
              <label for="serverSel">uplink node</label>
              <select id="serverSel">
                <option value="neo-1">NEO-1 • Downtown Relay</option>
                <option value="arc-7">ARC-7 • Subnet Spire</option>
                <option value="hex-3">HEX-3 • Industrial Backbone</option>
                <option value="luna-9">LUNA-9 • Edge Satellite</option>
              </select>
            </div>

            <div class="toggle" title="Try real fetch-based measurement (requires endpoints on your domain). Falls back safely.">
              <div class="switch" id="swReal" role="switch" aria-checked="false" tabindex="0"></div>
              <label for="swReal">real test</label>
            </div>

            <div class="toggle" title="Switch gauge to a smaller max range for slower links.">
              <div class="switch" id="swRange" role="switch" aria-checked="false" tabindex="0"></div>
              <label for="swRange">boost precision</label>
            </div>
          </div>
        </div>

        <div class="gauge-wrap">
          <div class="gauge">
            <canvas id="gaugeCanvas" width="1600" height="860" aria-label="Speedometer gauge"></canvas>

            <div class="gauge-overlay" aria-hidden="true">
              <div class="gauge-center-readout">
                <div class="gauge-center-speed"><span id="speedCenterVal">0.00</span></div>
              </div>

              <div class="gauge-bottom-readout">
                <div class="gauge-slot">
                  <div class="gauge-slot-val"><span id="ulGaugeVal">--</span></div>
                </div>
                <div class="gauge-slot">
                  <div class="gauge-slot-val"><span id="pingGaugeVal">--</span></div>
                </div>
                <div class="gauge-slot">
                  <div class="gauge-slot-val"><span id="dlGaugeVal">--</span></div>
                </div>
              </div>
            </div>

            <div class="readout">
              <div>
                <div class="speed-num"><span id="speedVal">0.00</span></div>
                <div class="unit"><span id="speedUnit">Mbps</span> • <span id="phaseTiny">Idle</span></div>
              </div>
              <div class="phase">
                <div>Status: <b id="phaseLabel">Awaiting command</b></div>
                <div class="progress" aria-label="Phase progress">
                  <i id="phaseBar"></i>
                </div>
              </div>
            </div>
          </div>

          <aside class="hud">
            <div class="hud-grid">
              <div class="hud-item">
                <div class="hud-k">Ping</div>
                <div class="hud-v"><span id="pingVal">--</span> <small>ms</small></div>
              </div>
              <div class="hud-item">
                <div class="hud-k">Jitter</div>
                <div class="hud-v"><span id="jitterVal">--</span> <small>ms</small></div>
              </div>

              <div class="hud-item">
                <div class="hud-k">Download</div>
                <div class="hud-v"><span id="dlVal">--</span> <small>Mbps</small></div>
              </div>
              <div class="hud-item">
                <div class="hud-k">Upload</div>
                <div class="hud-v"><span id="ulVal">--</span> <small>Mbps</small></div>
              </div>

              <div class="hud-item hud-wide">
                <div class="hud-k">Signal integrity</div>
                <div class="signalbar"><i id="sigFill"></i></div>
                <div class="row" style="text-transform:none;letter-spacing:.04em;">
                  <span style="color:rgba(230,251,255,.55)">Loss est.</span>
                  <b id="lossVal" style="font-weight:800;">0.0%</b>
                  <span style="color:rgba(230,251,255,.55)">Bufferbloat</span>
                  <b id="bbVal" style="font-weight:800;">low</b>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- SIDE PANEL -->
      <section class="side">
        <section class="card">
          <div class="card-header">
            <h2 class="title">Link analysis</h2>
            <div class="meta">
              <span>Threat: <b id="threatLabel">LOW</b></span>
            </div>
          </div>
          <div class="list">
            <div class="row">
              <span>Uplink route</span>
              <span class="tag good"><i></i><span id="routeTag">Clean</span></span>
            </div>
            <div class="row">
              <span>RF noise</span>
              <span class="tag" id="rfTag"><i></i><span id="rfTxt">Nominal</span></span>
            </div>
            <div class="row">
              <span>Congestion</span>
              <span class="tag warn" id="congTag"><i></i><span id="congTxt">Unknown</span></span>
            </div>
            <div class="row">
              <span>Protocol</span>
              <span class="tag"><i></i><span id="protoTxt">HTTP/2 (sim)</span></span>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2 class="title">History trace</h2>
            <div class="meta">
              <span>Samples: <b id="histCount">0</b></span>
            </div>
          </div>
          <div class="chart">
            <canvas id="histCanvas" width="900" height="420" aria-label="History chart"></canvas>
          </div>
        </section>
      </section>
    </main>

    <div class="footer">
      <div>© 2099 NEONLINK DIAGNOSTICS • Pure black mode</div>

      <button class="cybr-btn" id="exportBtn" type="button">
        EXPORT LAST RESULT
        <span aria-hidden="true" class="cybr-btn__glitch">EXPORT LAST RESULT</span>
      </button>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    const ui = {
      speedCenterVal: $("speedCenterVal"),
      pingGaugeVal: $("pingGaugeVal"),
      dlGaugeVal: $("dlGaugeVal"),
      ulGaugeVal: $("ulGaugeVal"),

      pingVal: $("pingVal"),
      jitterVal: $("jitterVal"),
      dlVal: $("dlVal"),
      ulVal: $("ulVal"),

      sigFill: $("sigFill"),
      lossVal: $("lossVal"),
      bbVal: $("bbVal"),
      threatLabel: $("threatLabel"),
      routeTag: $("routeTag"),
      rfTxt: $("rfTxt"),
      congTxt: $("congTxt"),
      protoTxt: $("protoTxt"),
      serverName: $("serverName"),
      modeLabel: $("modeLabel"),
      histCount: $("histCount"),
      netState: $("netState"),

      btnStart: $("btnStart"),
      btnAbort: $("btnAbort"),
      btnReset: $("btnReset"),

      swReal: $("swReal"),
      swRange: $("swRange"),

      serverSel: $("serverSel"),
      exportBtn: $("exportBtn")
    };

    const gCanvas = $("gaugeCanvas");
    const gCtx = gCanvas.getContext("2d");

    const hCanvas = $("histCanvas");
    const hCtx = hCanvas.getContext("2d");

    function fitCanvasToCSS(canvas){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      return {w,h,dpr};
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function lerp(a,b,t){ return a + (b-a)*t; }

    const C = {
      cyan:   [0, 235, 255],
      blue:   [0, 160, 255],
      amber:  [255, 174, 0],
      red:    [255, 47, 77],
      white:  [230, 251, 255]
    };
    function rgba(r,g,b,a){ return `rgba(${r},${g},${b},${a})`; }

    const state = {
      running: false,
      aborted: false,
      useReal: false,
      precisionRange: false,
      speed: 0,
      target: 0,
      ping: null,
      jitter: null,
      dl: null,
      ul: null,
      loss: 0,
      bb: "low",
      threat: "LOW",
      server: "neo-1",
      history: []
    };

    const servers = {
      "neo-1": { name: "NEO-1", baseDl: 520, baseUl: 95, ping: 9 },
      "arc-7": { name: "ARC-7", baseDl: 740, baseUl: 120, ping: 12 },
      "hex-3": { name: "HEX-3", baseDl: 310, baseUl: 52, ping: 18 },
      "luna-9": { name: "LUNA-9", baseDl: 160, baseUl: 28, ping: 38 }
    };

    function nrand(){
      let u = 1 - Math.random();
      let v = 1 - Math.random();
      return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
    }
    function fmt(x, digits=2){
      if (x === null || x === undefined || Number.isNaN(x)) return "--";
      return Number(x).toFixed(digits);
    }
    function avg(arr){ return arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length); }
    function stddev(arr){
      if (arr.length < 2) return 0;
      const m = avg(arr);
      const v = arr.reduce((s,x)=>s + (x-m)*(x-m), 0) / (arr.length-1);
      return Math.sqrt(v);
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function updateHUD(){
      ui.speedCenterVal.textContent = fmt(state.speed, 2);
      ui.pingGaugeVal.textContent = fmt(state.ping, 0);
      ui.dlGaugeVal.textContent = fmt(state.dl, 2);
      ui.ulGaugeVal.textContent = fmt(state.ul, 2);

      ui.pingVal.textContent = fmt(state.ping, 0);
      ui.jitterVal.textContent = fmt(state.jitter, 1);
      ui.dlVal.textContent = fmt(state.dl, 2);
      ui.ulVal.textContent = fmt(state.ul, 2);

      ui.lossVal.textContent = `${fmt(state.loss, 1)}%`;
      ui.bbVal.textContent = state.bb;
      ui.threatLabel.textContent = state.threat;

      const rf = clamp(60 + (state.ping ? (30 - state.ping) : 0) + (state.jitter ? (12 - state.jitter) : 0) + nrand()*2, 5, 95);
      ui.sigFill.style.width = `${rf}%`;

      ui.netState.textContent = (rf > 68) ? "LINK: STABLE • RF: NOMINAL" : "LINK: DEGRADED • RF: NOISY";
      ui.congTxt.textContent = (state.ping && state.ping < 25) ? "Minimal" : "Moderate";
      ui.rfTxt.textContent = (rf > 78) ? "Nominal" : (rf > 55) ? "Noisy" : "Interference";
      ui.histCount.textContent = String(state.history.length);
    }

    function setServer(id){
      state.server = id;
      ui.serverName.textContent = servers[id]?.name || id.toUpperCase();
    }

    function drawGauge(){
      const {w,h} = fitCanvasToCSS(gCanvas);
      gCtx.clearRect(0,0,w,h);

      const cx = w * 0.50;
      const cy = h * 0.80;
      const r  = Math.min(w, h) * 0.55;

      const start = Math.PI * 1.12;
      const end   = Math.PI * 1.98;

      const maxMbps = state.precisionRange ? 200 : 1000;
      const value = clamp(state.speed, 0, maxMbps);
      const t = value / maxMbps;

      const halo = gCtx.createRadialGradient(cx, cy, r*0.2, cx, cy, r*1.0);
      halo.addColorStop(0, rgba(...C.cyan, 0.06));
      halo.addColorStop(0.55, rgba(...C.amber, 0.03));
      halo.addColorStop(1, rgba(0,0,0,0));
      gCtx.fillStyle = halo;
      gCtx.beginPath();
      gCtx.arc(cx, cy, r*1.05, 0, Math.PI*2);
      gCtx.fill();

      const needleA = lerp(start, end, t);
      const nx = cx + Math.cos(needleA) * (r*0.90);
      const ny = cy + Math.sin(needleA) * (r*0.90);

      const bladeW = r * 0.030;
      const backLen = r * 0.18;

      const px = Math.cos(needleA + Math.PI/2) * bladeW;
      const py = Math.sin(needleA + Math.PI/2) * bladeW;

      const bx = cx - Math.cos(needleA) * backLen;
      const by = cy - Math.sin(needleA) * backLen;

      const blade = gCtx.createLinearGradient(bx, by, nx, ny);
      blade.addColorStop(0, rgba(...C.white, .12));
      blade.addColorStop(0.35, rgba(...C.blue, .40));
      blade.addColorStop(0.75, rgba(...C.cyan, .58));
      blade.addColorStop(1, rgba(...C.amber, .62));

      gCtx.fillStyle = blade;
      gCtx.strokeStyle = rgba(...C.white, .10);
      gCtx.lineWidth = 2;

      gCtx.beginPath();
      gCtx.moveTo(bx + px, by + py);
      gCtx.lineTo(cx + px, cy + py);
      gCtx.lineTo(nx, ny);
      gCtx.lineTo(cx - px, cy - py);
      gCtx.lineTo(bx - px, by - py);
      gCtx.closePath();
      gCtx.fill();
      gCtx.stroke();

      gCtx.fillStyle = rgba(...C.white, .12);
      gCtx.beginPath();
      gCtx.arc(cx, cy, r*0.055, 0, Math.PI*2);
      gCtx.fill();
    }

    function drawHistory(){
      const {w,h} = fitCanvasToCSS(hCanvas);
      hCtx.clearRect(0,0,w,h);
      const pad = Math.max(18, Math.floor(w*0.04));
      const x0 = pad, y0 = pad, x1 = w - pad, y1 = h - pad;
      const cw = x1 - x0, ch = y1 - y0;

      hCtx.strokeStyle = rgba(...C.cyan, .14);
      hCtx.lineWidth = 2;
      hCtx.strokeRect(x0, y0, cw, ch);

      if (state.history.length === 0) return;

      const data = state.history.slice(-20);
      const maxY = Math.max(...data.map(d=>Math.max(d.dl||0, d.ul||0)), 1) * 1.15;

      function plot(vals, cA, cB){
        const grad = hCtx.createLinearGradient(x0,y0,x1,y1);
        grad.addColorStop(0, rgba(...cA, .60));
        grad.addColorStop(1, rgba(...cB, .50));
        hCtx.strokeStyle = grad;
        hCtx.lineWidth = 3;
        hCtx.beginPath();
        vals.forEach((v,i)=>{
          const tt = (data.length === 1) ? 0 : (i/(data.length-1));
          const x = x0 + tt*cw;
          const y = y1 - (v/maxY)*ch;
          if (i===0) hCtx.moveTo(x,y); else hCtx.lineTo(x,y);
        });
        hCtx.stroke();
      }

      plot(data.map(d=>d.dl||0), C.cyan, C.amber);
      plot(data.map(d=>d.ul||0), C.amber, C.cyan);
    }

    function animateNeedle(){
      const diff = state.target - state.speed;
      state.speed += diff * 0.14;
      if (Math.abs(diff) < 0.02) state.speed = state.target;

      updateHUD();
      drawGauge();
      drawHistory();
      requestAnimationFrame(animateNeedle);
    }

    async function runSim(){
      const s = servers[state.server] || servers["neo-1"];
      ui.modeLabel.textContent = "SIM";
      ui.protoTxt.textContent = "HTTP/2 (sim)";
      state.useReal = false;

      const pings = [];
      const basePing = s.ping + Math.max(0, nrand()*2);

      for (let i=0;i<10;i++){
        if (state.aborted) throw new Error("aborted");
        const jitter = Math.abs(nrand()*2.4);
        const val = basePing + jitter;
        pings.push(val);
        state.ping = val;
        state.jitter = i<2 ? null : stddev(pings);
        state.target = (i/10)*18;
        await sleep(65 + Math.random()*60);
      }
      state.ping = avg(pings);
      state.jitter = stddev(pings);

      const dlTarget = s.baseDl * (0.88 + Math.random()*0.30);
      for (let t=0; t<=1.0; t += 0.016){
        if (state.aborted) throw new Error("aborted");
        const noise = nrand()* (dlTarget*0.015);
        state.dl = clamp(dlTarget*(1 - Math.pow(1-t,3.1)) + noise, 0, dlTarget*1.05);
        state.target = state.dl;
        state.loss = clamp(Math.abs(nrand()) * 0.7 + ((state.jitter||0)/50), 0, 6.5);
        state.bb = ((state.jitter||0) < 6) ? "low" : ((state.jitter||0) < 14) ? "med" : "high";
        await sleep(16);
      }
      state.dl = dlTarget;

      const ulTarget = s.baseUl * (0.86 + Math.random()*0.34);
      for (let t=0; t<=1.0; t += 0.016){
        if (state.aborted) throw new Error("aborted");
        const noise = nrand()* (ulTarget*0.02);
        state.ul = clamp(ulTarget*(1 - Math.pow(1-t,3.1)) + noise, 0, ulTarget*1.08);
        state.target = state.ul;
        await sleep(16);
      }
      state.ul = ulTarget;

      state.history.push({ ts: Date.now(), ping: state.ping, jitter: state.jitter, dl: state.dl, ul: state.ul });
      if (state.history.length > 60) state.history.shift();

      state.target = 0;
    }

    async function runTest(){
      if (state.running) return;
      state.running = true;
      state.aborted = false;

      ui.btnStart.disabled = true;
      ui.btnAbort.disabled = false;

      state.speed = 0;
      state.target = 0;
      state.ping = null;
      state.jitter = null;
      state.dl = null;
      state.ul = null;
      state.loss = 0;
      state.bb = "low";

      try{
        await runSim();
      } catch (e){
        // ignore
      } finally{
        state.running = false;
        ui.btnStart.disabled = false;
        ui.btnAbort.disabled = true;
      }
    }

    function abortTest(){
      if (!state.running) return;
      state.aborted = true;
      state.target = 0;
      ui.btnAbort.disabled = true;
    }

    function resetUI(){
      if (state.running) return;
      state.speed = 0;
      state.target = 0;
      state.ping = null;
      state.jitter = null;
      state.dl = null;
      state.ul = null;
      state.loss = 0;
      state.bb = "low";
      updateHUD();
    }

    function toggleSwitch(el, on){
      el.classList.toggle("on", on);
      el.setAttribute("aria-checked", on ? "true" : "false");
    }

    function clickSwitch(sw, handler){
      sw.addEventListener("click", handler);
      sw.addEventListener("keydown", (e)=>{
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          handler();
        }
      });
    }

    ui.btnStart.addEventListener("click", runTest);
    ui.btnAbort.addEventListener("click", abortTest);
    ui.btnReset.addEventListener("click", resetUI);

    ui.serverSel.addEventListener("change", (e)=> setServer(e.target.value));

    clickSwitch(ui.swReal, ()=>{
      if (state.running) return;
      state.useReal = !state.useReal;
      toggleSwitch(ui.swReal, state.useReal);
      ui.modeLabel.textContent = state.useReal ? "REAL" : "AUTO";
    });

    clickSwitch(ui.swRange, ()=>{
      if (state.running) return;
      state.precisionRange = !state.precisionRange;
      toggleSwitch(ui.swRange, state.precisionRange);
    });

    ui.exportBtn.addEventListener("click", ()=>{
      const last = state.history[state.history.length - 1];
      const payload = {
        server: state.server,
        ts: new Date(last?.ts || Date.now()).toISOString(),
        ping_ms: last?.ping ?? null,
        jitter_ms: last?.jitter ?? null,
        download_mbps: last?.dl ?? null,
        upload_mbps: last?.ul ?? null,
        mode: state.useReal ? "REAL" : "SIM"
      };
      navigator.clipboard?.writeText(JSON.stringify(payload, null, 2)).catch(()=>{});
    });

    setServer(ui.serverSel.value);
    updateHUD();
    animateNeedle();

    window.addEventListener("resize", ()=>{
      drawGauge();
      drawHistory();
    });

    drawGauge();
    drawHistory();
  </script>
</body>
</html>