<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Discovery Map</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;}
body{font-family:"Share Tech Mono",monospace;color:rgba(255,255,255,0.9);}

/* â”€â”€ THEME VARIABLES â”€â”€ */
:root{
  --p:#00f0ff;--s:#b967ff;--a:#78ffdc;
  --pg:rgba(0,240,255,0.18);--sg:rgba(185,103,255,0.14);
  --ps:rgba(0,240,255,0.28);--ss:rgba(185,103,255,0.22);
}
[data-theme="matrix"]{--p:#00ff41;--s:#00cc33;--a:#39ff14;--pg:rgba(0,255,65,0.18);--sg:rgba(0,204,51,0.14);--ps:rgba(0,255,65,0.28);--ss:rgba(0,204,51,0.22);}
[data-theme="aurora"]{--p:#bf00ff;--s:#00ff9d;--a:#9d00ff;--pg:rgba(191,0,255,0.18);--sg:rgba(0,255,157,0.14);--ps:rgba(191,0,255,0.28);--ss:rgba(0,255,157,0.22);}
[data-theme="solar"]{--p:#ff8c00;--s:#ff1493;--a:#ffd700;--pg:rgba(255,140,0,0.18);--sg:rgba(255,20,147,0.14);--ps:rgba(255,140,0,0.28);--ss:rgba(255,20,147,0.22);}
[data-theme="ice"]{--p:#a8d8ff;--s:#4488ff;--a:#e0f4ff;--pg:rgba(168,216,255,0.18);--sg:rgba(68,136,255,0.14);--ps:rgba(168,216,255,0.28);--ss:rgba(68,136,255,0.22);}
[data-theme="ghost"]{--p:#ffffff;--s:#aaaaaa;--a:#dddddd;--pg:rgba(255,255,255,0.12);--sg:rgba(170,170,170,0.10);--ps:rgba(255,255,255,0.22);--ss:rgba(170,170,170,0.16);}

/* â”€â”€ LAYOUT â”€â”€ */
#app{
  width:100vw;height:100vh;
  display:flex;flex-direction:column;
  background:#000;
  position:relative;overflow:hidden;
}

/* scanline overlay */
#app::after{
  content:"";position:absolute;inset:0;pointer-events:none;z-index:1;
  background:repeating-linear-gradient(0deg,rgba(0,0,0,0.25) 0 1px,transparent 1px 3px);
  animation:scanPan 8s linear infinite;
  opacity:.35;
}
@keyframes scanPan{0%{background-position:0 0;}100%{background-position:0 60px;}}

/* â”€â”€ TOP BAR â”€â”€ */
#topbar{
  position:relative;z-index:100;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;
  background:rgba(0,0,0,0.95);
  border-bottom:1px solid rgba(var(--p-raw,0,240,255),0.25);
  box-shadow:0 2px 30px rgba(0,0,0,0.8);
  gap:12px;flex-wrap:wrap;
}
.top-brand{
  display:flex;align-items:center;gap:10px;
}
.top-badge{
  width:38px;height:38px;border-radius:10px;
  background:linear-gradient(135deg,var(--p),var(--s));
  display:grid;place-items:center;
  font-family:"Orbitron",sans-serif;font-size:13px;font-weight:900;color:#000;
  box-shadow:0 0 18px var(--pg);
  animation:badgePulse 3s ease-in-out infinite;
}
@keyframes badgePulse{0%,100%{box-shadow:0 0 14px var(--pg);}50%{box-shadow:0 0 28px var(--ps),0 0 50px var(--sg);}}
.top-title{
  font-family:"Orbitron",sans-serif;font-size:13px;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;
  text-shadow:0 0 16px var(--p);
}
.top-sub{font-size:10px;color:rgba(255,255,255,0.55);margin-top:2px;letter-spacing:1px;}

.top-stats{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
}
.stat-chip{
  display:flex;flex-direction:column;align-items:center;
  padding:6px 12px;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:10px;
  min-width:60px;
}
.stat-chip .sv{font-size:18px;font-weight:700;color:var(--p);text-shadow:0 0 12px var(--pg);font-family:"Orbitron",sans-serif;}
.stat-chip .sl{font-size:9px;color:rgba(255,255,255,0.55);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}
.stat-chip.online .sv{color:#00ff88;text-shadow:0 0 12px rgba(0,255,136,0.35);}
.stat-chip.threat .sv{color:#ff3366;text-shadow:0 0 12px rgba(255,51,102,0.35);}

.top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.hbtn{
  display:flex;align-items:center;gap:6px;
  padding:8px 12px;border-radius:10px;cursor:pointer;
  border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.5);
  color:rgba(255,255,255,0.85);font:inherit;font-size:12px;
  transition:all .2s ease;letter-spacing:.6px;text-transform:uppercase;
  white-space:nowrap;
}
.hbtn:hover{background:var(--pg);border-color:var(--p);color:var(--a);box-shadow:0 0 18px var(--pg);}
.hbtn.active{background:var(--pg);border-color:var(--p);color:var(--a);}
.hbtn.primary{background:linear-gradient(135deg,var(--pg),var(--sg));border-color:var(--p);color:var(--a);box-shadow:0 0 18px var(--pg);}

/* â”€â”€ TOOLBAR â”€â”€ */
#toolbar{
  position:relative;z-index:100;
  display:flex;align-items:center;gap:8px;
  padding:8px 16px;
  background:rgba(0,0,0,0.90);
  border-bottom:1px solid rgba(255,255,255,0.06);
  overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none;
  flex-wrap:nowrap;
}
#toolbar::-webkit-scrollbar{display:none;}
.tb-group{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.tb-sep{width:1px;height:28px;background:rgba(255,255,255,0.10);flex-shrink:0;}
.tb-label{font-size:9px;color:rgba(255,255,255,0.45);letter-spacing:1px;text-transform:uppercase;white-space:nowrap;}
.tbtn{
  padding:6px 12px;border-radius:8px;cursor:pointer;
  border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.4);
  color:rgba(255,255,255,0.75);font:inherit;font-size:11px;
  transition:all .18s ease;white-space:nowrap;letter-spacing:.5px;
}
.tbtn:hover{background:var(--pg);border-color:var(--p);color:var(--a);}
.tbtn.active{background:var(--pg);border-color:var(--p);color:var(--a);box-shadow:0 0 12px var(--pg);}

/* theme swatches */
.tswatch{
  width:28px;height:28px;border-radius:8px;cursor:pointer;
  border:2px solid rgba(255,255,255,0.12);transition:all .18s ease;flex-shrink:0;
}
.tswatch:hover,.tswatch.active{border-color:rgba(255,255,255,0.5);transform:scale(1.12);box-shadow:0 0 14px rgba(255,255,255,0.2);}

/* â”€â”€ CANVAS AREA â”€â”€ */
#canvasWrap{
  flex:1 1 auto;position:relative;overflow:hidden;background:#000;
}

/* depth fog at edges */
#canvasWrap::before{
  content:"";position:absolute;inset:0;pointer-events:none;z-index:5;
  background:
    radial-gradient(ellipse at center,transparent 55%,rgba(0,0,0,0.75) 100%),
    linear-gradient(180deg,rgba(0,0,0,0.4) 0%,transparent 12%,transparent 88%,rgba(0,0,0,0.4) 100%);
}

/* animated corner brackets */
#canvasWrap::after{
  content:"";position:absolute;inset:0;pointer-events:none;z-index:6;
  background:
    linear-gradient(var(--p),var(--p)) top left / 40px 2px no-repeat,
    linear-gradient(var(--p),var(--p)) top left / 2px 40px no-repeat,
    linear-gradient(var(--p),var(--p)) top right / 40px 2px no-repeat,
    linear-gradient(var(--p),var(--p)) top right / 2px 40px no-repeat,
    linear-gradient(var(--p),var(--p)) bottom left / 40px 2px no-repeat,
    linear-gradient(var(--p),var(--p)) bottom left / 2px 40px no-repeat,
    linear-gradient(var(--p),var(--p)) bottom right / 40px 2px no-repeat,
    linear-gradient(var(--p),var(--p)) bottom right / 2px 40px no-repeat;
  opacity:.6;animation:bracketPulse 3s ease-in-out infinite;
}
@keyframes bracketPulse{0%,100%{opacity:.4;}50%{opacity:.85;}}

#bg-canvas{position:absolute;inset:0;z-index:0;}
#map-canvas{position:absolute;inset:0;z-index:2;touch-action:none;cursor:grab;}
#map-canvas:active{cursor:grabbing;}
#fx-canvas{position:absolute;inset:0;z-index:3;pointer-events:none;}

/* â”€â”€ HUD OVERLAYS â”€â”€ */
.hud{position:absolute;z-index:8;pointer-events:none;}
.hud.interactive{pointer-events:auto;}

#hud-tl{top:14px;left:14px;}
#hud-tr{top:14px;right:14px;}
#hud-bl{bottom:14px;left:14px;}
#hud-br{bottom:14px;right:14px;}

.hud-panel{
  background:rgba(0,0,0,0.82);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:12px;padding:10px 14px;
  backdrop-filter:blur(12px);
  box-shadow:0 4px 24px rgba(0,0,0,0.6);
  font-size:11px;
}
.hud-title{
  font-size:9px;letter-spacing:1.8px;text-transform:uppercase;
  color:var(--p);text-shadow:0 0 10px var(--pg);margin-bottom:8px;
}

/* compass / orientation widget */
#compass{
  width:64px;height:64px;position:relative;
  border:1px solid rgba(255,255,255,0.08);border-radius:50%;
  background:rgba(0,0,0,0.6);
  box-shadow:0 0 20px rgba(0,0,0,0.8);
}
#compass-ring{
  width:100%;height:100%;border-radius:50%;
  border:2px solid var(--p);
  box-shadow:0 0 14px var(--pg),inset 0 0 14px var(--pg);
  animation:compassGlow 2s ease-in-out infinite;
  position:absolute;top:0;left:0;
}
@keyframes compassGlow{0%,100%{box-shadow:0 0 8px var(--pg),inset 0 0 8px var(--pg);}50%{box-shadow:0 0 20px var(--ps),inset 0 0 18px var(--ps);}}
#compass-n{
  position:absolute;top:4px;left:50%;transform:translateX(-50%);
  font-size:8px;font-weight:700;color:var(--p);letter-spacing:1px;
}
#compass-needle{
  position:absolute;top:50%;left:50%;
  width:2px;height:22px;background:linear-gradient(var(--p),transparent);
  transform-origin:bottom center;margin-left:-1px;margin-top:-22px;
  box-shadow:0 0 8px var(--p);
  transition:transform .3s ease;
}

/* mini legend */
.legend-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:10px;color:rgba(255,255,255,0.75);}
.legend-row:last-child{margin-bottom:0;}
.legend-icon{width:22px;height:22px;border-radius:6px;display:grid;place-items:center;font-size:13px;flex-shrink:0;}

/* activity feed */
#activityFeed{max-height:120px;overflow-y:auto;scrollbar-width:none;}
#activityFeed::-webkit-scrollbar{display:none;}
.af-item{
  padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);
  font-size:10px;color:rgba(255,255,255,0.65);
  display:flex;gap:8px;align-items:flex-start;
}
.af-item:last-child{border-bottom:none;}
.af-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:3px;}
.af-time{color:rgba(255,255,255,0.40);white-space:nowrap;font-size:9px;}

/* zoom indicator */
#zoomHud{font-size:11px;color:var(--p);text-align:center;padding:6px 10px;}
.zoom-bar{
  width:80px;height:4px;background:rgba(255,255,255,0.08);
  border-radius:2px;margin:4px auto 0;overflow:hidden;
}
.zoom-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--s));border-radius:2px;transition:width .2s ease;}

/* â”€â”€ NODE TOOLTIP â”€â”€ */
#tooltip{
  position:absolute;z-index:20;
  min-width:220px;max-width:280px;
  background:rgba(0,0,0,0.95);
  border:1px solid var(--p);
  border-radius:14px;
  padding:14px;
  box-shadow:0 0 30px var(--pg),0 8px 32px rgba(0,0,0,0.8);
  pointer-events:none;
  display:none;
  backdrop-filter:blur(16px);
  transition:opacity .15s ease;
}
#tooltip.show{display:block;}
.tt-head{
  display:flex;align-items:center;gap:10px;margin-bottom:10px;
  padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.08);
}
.tt-icon{
  width:38px;height:38px;border-radius:10px;
  display:grid;place-items:center;font-size:20px;
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);
  flex-shrink:0;
}
.tt-name{font-size:12px;font-weight:700;color:rgba(255,255,255,0.95);letter-spacing:.5px;}
.tt-type{font-size:10px;color:var(--p);margin-top:2px;text-shadow:0 0 8px var(--pg);}
.tt-kv{display:grid;grid-template-columns:auto 1fr;gap:4px 10px;font-size:10px;}
.tt-k{color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:.8px;}
.tt-v{color:rgba(255,255,255,0.9);text-align:right;}
.tt-status{
  margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08);
  display:flex;align-items:center;gap:6px;font-size:10px;
}
.tt-dot{width:7px;height:7px;border-radius:50%;}

/* â”€â”€ BOTTOM STATUS â”€â”€ */
#statusbar{
  position:relative;z-index:100;
  display:flex;align-items:center;gap:14px;
  padding:6px 16px;
  background:rgba(0,0,0,0.95);
  border-top:1px solid rgba(255,255,255,0.06);
  font-size:10px;color:rgba(255,255,255,0.50);
  overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none;
  white-space:nowrap;
}
#statusbar::-webkit-scrollbar{display:none;}
.sb-item{display:flex;align-items:center;gap:5px;}
.sb-dot{width:6px;height:6px;border-radius:50%;background:var(--p);box-shadow:0 0 6px var(--p);animation:sbPulse 2s ease-in-out infinite;}
@keyframes sbPulse{0%,100%{opacity:.6;}50%{opacity:1;}}
</style>
</head>
<body>
<div id="app" data-theme="cyber">

  <!-- TOP BAR -->
  <div id="topbar">
    <div class="top-brand">
      <div class="top-badge">MN</div>
      <div>
        <div class="top-title">Discovery Map</div>
        <div class="top-sub" id="topSub">NETWORK TOPOLOGY VISUALIZER â€¢ LIVE</div>
      </div>
    </div>

    <div class="top-stats">
      <div class="stat-chip"><div class="sv" id="scTotal">0</div><div class="sl">Total</div></div>
      <div class="stat-chip online"><div class="sv" id="scOnline">0</div><div class="sl">Online</div></div>
      <div class="stat-chip threat"><div class="sv" id="scThreats">0</div><div class="sl">Threats</div></div>
      <div class="stat-chip"><div class="sv" id="scLinks">0</div><div class="sl">Links</div></div>
    </div>

    <div class="top-actions">
      <button class="hbtn primary" id="btnScan">âŸ³ Scan</button>
      <button class="hbtn" id="btnReset">âŸ² Reset</button>
      <button class="hbtn" id="btnAutoRotate">â†» Auto</button>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div id="toolbar">
    <div class="tb-group">
      <span class="tb-label">Layout</span>
      <button class="tbtn active" data-mode="star">â­ Star</button>
      <button class="tbtn" data-mode="ring">â­• Ring</button>
      <button class="tbtn" data-mode="mesh">ğŸ•¸ Mesh</button>
      <button class="tbtn" data-mode="tree">ğŸŒ³ Tree</button>
      <button class="tbtn" data-mode="cluster">ğŸ«§ Cluster</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="tb-label">View</span>
      <button class="tbtn active" data-view="3d">3D</button>
      <button class="tbtn" data-view="top">Top</button>
      <button class="tbtn" data-view="side">Side</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="tb-label">Filter</span>
      <button class="tbtn active" data-filter="all">All</button>
      <button class="tbtn" data-filter="online">Online</button>
      <button class="tbtn" data-filter="threat">Threats</button>
      <button class="tbtn" data-filter="trusted">Trusted</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="tb-label">FX</span>
      <button class="tbtn active" data-fx="particles" title="Particles">âœ¦ Particles</button>
      <button class="tbtn active" data-fx="beams" title="Data beams">âš¡ Beams</button>
      <button class="tbtn" data-fx="heatmap" title="Heatmap">ğŸŒ¡ Heat</button>
      <button class="tbtn active" data-fx="labels" title="Labels">ğŸ· Labels</button>
      <button class="tbtn" data-fx="grid" title="Grid">â–¦ Grid</button>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="tb-label">Theme</span>
      <div class="tswatch active" data-theme="cyber" style="background:linear-gradient(135deg,#00f0ff,#b967ff);" title="Cyber"></div>
      <div class="tswatch" data-theme="matrix" style="background:linear-gradient(135deg,#00ff41,#003300);" title="Matrix"></div>
      <div class="tswatch" data-theme="aurora" style="background:linear-gradient(135deg,#bf00ff,#00ff9d);" title="Aurora"></div>
      <div class="tswatch" data-theme="solar" style="background:linear-gradient(135deg,#ff8c00,#ff1493);" title="Solar"></div>
      <div class="tswatch" data-theme="ice" style="background:linear-gradient(135deg,#a8d8ff,#4488ff);" title="Ice"></div>
      <div class="tswatch" data-theme="ghost" style="background:linear-gradient(135deg,#ffffff,#666666);" title="Ghost"></div>
    </div>
    <div class="tb-sep"></div>
    <div class="tb-group">
      <span class="tb-label">Speed</span>
      <button class="tbtn" data-speed="0.5">0.5Ã—</button>
      <button class="tbtn active" data-speed="1">1Ã—</button>
      <button class="tbtn" data-speed="2">2Ã—</button>
    </div>
  </div>

  <!-- CANVAS -->
  <div id="canvasWrap">
    <canvas id="bg-canvas"></canvas>
    <canvas id="map-canvas"></canvas>
    <canvas id="fx-canvas"></canvas>

    <!-- HUD: Top Left â€” Activity -->
    <div class="hud interactive" id="hud-tl">
      <div class="hud-panel" style="width:210px;">
        <div class="hud-title">Activity Feed</div>
        <div id="activityFeed"></div>
      </div>
    </div>

    <!-- HUD: Top Right â€” Compass + Zoom -->
    <div class="hud" id="hud-tr" style="display:flex;flex-direction:column;align-items:flex-end;gap:10px;">
      <div class="hud-panel" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px;">
        <div id="compass">
          <div id="compass-ring"></div>
          <div id="compass-n">N</div>
          <div id="compass-needle"></div>
        </div>
      </div>
      <div class="hud-panel" style="padding:6px 12px;">
        <div id="zoomHud">100%<div class="zoom-bar"><div class="zoom-fill" id="zoomFill" style="width:40%;"></div></div></div>
      </div>
    </div>

    <!-- HUD: Bottom Left â€” Legend -->
    <div class="hud" id="hud-bl">
      <div class="hud-panel" style="width:170px;">
        <div class="hud-title">Device Types</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(0,240,255,0.12);border-color:rgba(0,240,255,0.3);">ğŸ”€</div>Router / Gateway</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(100,200,255,0.10);">ğŸ’»</div>PC / Laptop</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(100,255,100,0.10);">ğŸ“±</div>Phone / Tablet</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(255,200,0,0.10);">ğŸ“º</div>Smart TV</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(255,150,0,0.10);">ğŸ”Œ</div>IoT / Sensor</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(200,100,255,0.10);">ğŸ–¨</div>Printer</div>
        <div class="legend-row"><div class="legend-icon" style="background:rgba(255,80,80,0.15);border:1px solid rgba(255,80,80,0.3);">âš </div>Unknown / Threat</div>
      </div>
    </div>

    <!-- HUD: Bottom Right â€” Coordinates / info -->
    <div class="hud" id="hud-br">
      <div class="hud-panel" style="text-align:right;min-width:150px;">
        <div class="hud-title" style="text-align:right;">Map Coords</div>
        <div style="font-size:10px;color:rgba(255,255,255,0.6);line-height:1.8;">
          <div>ROT <span id="infoRotX" style="color:var(--p);">58Â°</span> / <span id="infoRotZ" style="color:var(--s);">-10Â°</span></div>
          <div>ZOOM <span id="infoZoom" style="color:var(--a);">1.00Ã—</span></div>
          <div>NODES <span id="infoNodes" style="color:var(--p);">0</span></div>
          <div>MODE <span id="infoMode" style="color:var(--a);">STAR</span></div>
        </div>
      </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip">
      <div class="tt-head">
        <div class="tt-icon" id="ttIcon">ğŸ“±</div>
        <div>
          <div class="tt-name" id="ttName">Device Name</div>
          <div class="tt-type" id="ttType">Device Type</div>
        </div>
      </div>
      <div class="tt-kv" id="ttKv"></div>
      <div class="tt-status" id="ttStatus">
        <div class="tt-dot" id="ttDot"></div>
        <span id="ttStatusText">Online</span>
      </div>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div id="statusbar">
    <div class="sb-item"><div class="sb-dot"></div><span id="sbStatus">Ready</span></div>
    <div class="sb-item">MAP ENGINE v3.1</div>
    <div class="sb-item" id="sbTime">00:00:00</div>
    <div class="sb-item">SUBNET: 192.168.1.0/24</div>
    <div class="sb-item" id="sbFps">FPS: --</div>
    <div class="sb-item">RENDER: WebGL2</div>
  </div>
</div>

<script>
"use strict";

// â”€â”€â”€ DATA DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEVICE_TYPES = {
  router:  { icon:"ğŸ”€", label:"Router",   color:"#00f0ff", ring:"#78ffdc" },
  pc:      { icon:"ğŸ’»", label:"PC",       color:"#88ccff", ring:"#4488ff" },
  laptop:  { icon:"ğŸ’»", label:"Laptop",   color:"#aaddff", ring:"#6699ff" },
  phone:   { icon:"ğŸ“±", label:"Phone",    color:"#88ffaa", ring:"#00ff88" },
  tablet:  { icon:"ğŸ“±", label:"Tablet",   color:"#aaff88", ring:"#88ff00" },
  tv:      { icon:"ğŸ“º", label:"Smart TV", color:"#ffdd66", ring:"#ffaa00" },
  iot:     { icon:"ğŸ”Œ", label:"IoT",      color:"#ffaa44", ring:"#ff8800" },
  printer: { icon:"ğŸ–¨", label:"Printer",  color:"#cc99ff", ring:"#aa44ff" },
  camera:  { icon:"ğŸ“·", label:"Camera",   color:"#ff99cc", ring:"#ff44aa" },
  nas:     { icon:"ğŸ—„", label:"NAS",      color:"#99ddff", ring:"#22aaff" },
  server:  { icon:"ğŸ–¥", label:"Server",   color:"#ffddaa", ring:"#ffaa44" },
  unknown: { icon:"âš ", label:"Unknown",  color:"#ff3366", ring:"#cc0033" },
};

const DEMO_DEVICES = [
  { id:"gw1", name:"Main Router",    type:"router",  ip:"192.168.1.1",   mac:"A4:C3:F0:11:22:33", vendor:"ASUS",       trust:"Trusted",  online:true },
  { id:"d1",  name:"DESKTOP-HOME",   type:"pc",      ip:"192.168.1.10",  mac:"B8:27:EB:AA:BB:CC", vendor:"Intel",      trust:"Trusted",  online:true },
  { id:"d2",  name:"MacBook Pro",    type:"laptop",  ip:"192.168.1.11",  mac:"3C:22:FB:DD:EE:FF", vendor:"Apple",      trust:"Trusted",  online:true },
  { id:"d3",  name:"iPhone 15",      type:"phone",   ip:"192.168.1.20",  mac:"4A:F0:21:44:55:66", vendor:"Apple",      trust:"Trusted",  online:true },
  { id:"d4",  name:"Galaxy S24",     type:"phone",   ip:"192.168.1.21",  mac:"CC:98:8B:77:88:99", vendor:"Samsung",    trust:"Trusted",  online:false},
  { id:"d5",  name:"iPad Air",       type:"tablet",  ip:"192.168.1.22",  mac:"DC:A9:04:AB:CD:EF", vendor:"Apple",      trust:"Trusted",  online:true },
  { id:"d6",  name:"Samsung TV 65â€³", type:"tv",      ip:"192.168.1.30",  mac:"70:2A:D5:12:34:56", vendor:"Samsung",    trust:"Trusted",  online:true },
  { id:"d7",  name:"NestHub",        type:"iot",     ip:"192.168.1.40",  mac:"54:60:09:23:45:67", vendor:"Google",     trust:"Trusted",  online:true },
  { id:"d8",  name:"Hue Bridge",     type:"iot",     ip:"192.168.1.41",  mac:"00:17:88:34:56:78", vendor:"Signify",    trust:"Trusted",  online:true },
  { id:"d9",  name:"HP LaserJet",    type:"printer", ip:"192.168.1.50",  mac:"FC:F1:36:45:67:89", vendor:"HP",         trust:"Trusted",  online:false},
  { id:"d10", name:"Front Camera",   type:"camera",  ip:"192.168.1.60",  mac:"00:62:6E:56:78:9A", vendor:"Hikvision",  trust:"Trusted",  online:true },
  { id:"d11", name:"Synology NAS",   type:"nas",     ip:"192.168.1.70",  mac:"00:11:32:67:89:AB", vendor:"Synology",   trust:"Trusted",  online:true },
  { id:"d12", name:"Pi-hole",        type:"server",  ip:"192.168.1.80",  mac:"B8:27:EB:78:9A:BC", vendor:"RPi",        trust:"Trusted",  online:true },
  { id:"d13", name:"UNKNOWN_DEV_1",  type:"unknown", ip:"192.168.1.150", mac:"52:74:F2:89:AB:CD", vendor:"Unknown",    trust:"Unknown",  online:true },
  { id:"d14", name:"UNKNOWN_DEV_2",  type:"unknown", ip:"192.168.1.151", mac:"66:AB:12:9A:BC:DE", vendor:"Unknown",    trust:"Unknown",  online:true },
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  devices: DEMO_DEVICES,
  layout:"star", view:"3d", filter:"all",
  fx:{ particles:true, beams:true, heatmap:false, labels:true, grid:false },
  theme:"cyber", speed:1,
  rotX:54, rotZ:-12, zoom:1,
  autoRotate:false, autoDir:1,
  dragging:false, lastMx:0, lastMy:0,
  momentum:{ x:0, y:0 },
  nodes:[], links:[],
  particles:[], beams:[], ripples:[],
  selectedId:null, hoveredId:null,
  scanAnim:0, scanActive:false,
  fpsSamples:[], lastFrame:0,
  activity:[],
  animSpeed:1,
};

// Canvas refs
const mapC = document.getElementById("map-canvas");
const bgC  = document.getElementById("bg-canvas");
const fxC  = document.getElementById("fx-canvas");
const mctx = mapC.getContext("2d");
const bctx = bgC.getContext("2d");
const fctx = fxC.getContext("2d");
const wrap = document.getElementById("canvasWrap");

// â”€â”€â”€ RESIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resize(){
  const W = wrap.clientWidth, H = wrap.clientHeight;
  [mapC, bgC, fxC].forEach(c=>{ c.width=W; c.height=H; });
  buildGraph();
}
window.addEventListener("resize", resize);

// â”€â”€â”€ THEME HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getThemeColor(alpha=1){
  const cs = getComputedStyle(document.getElementById("app"));
  const hex = cs.getPropertyValue("--p").trim();
  return hexToRgba(hex, alpha);
}
function hexToRgba(hex, a=1){
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function getThemeHex(){
  return getComputedStyle(document.getElementById("app")).getPropertyValue("--p").trim();
}
function getSHex(){
  return getComputedStyle(document.getElementById("app")).getPropertyValue("--s").trim();
}
function getAHex(){
  return getComputedStyle(document.getElementById("app")).getPropertyValue("--a").trim();
}

// â”€â”€â”€ GRAPH BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filteredDevices(){
  const f = S.filter;
  return S.devices.filter(d=>{
    if(f==="online") return d.online;
    if(f==="threat") return d.trust==="Unknown" || d.type==="unknown";
    if(f==="trusted") return d.trust==="Trusted";
    return true;
  });
}

function buildGraph(){
  const W=mapC.width, H=mapC.height;
  const devs = filteredDevices();
  S.nodes = layoutNodes(devs, W, H);
  S.links = buildLinks(S.nodes);
  updateStats();
}

function layoutNodes(devs, W, H){
  const cx=W/2, cy=H/2;
  const router = devs.find(d=>d.type==="router");
  const others = devs.filter(d=>d.type!=="router");

  const nodes=[];

  // place router at center
  if(router){
    nodes.push(makeNode(router, cx, cy, 0, true));
  }

  const count = others.length;
  if(count===0) return nodes;

  switch(S.layout){
    case"star": {
      const r = Math.min(W,H)*0.32;
      others.forEach((d,i)=>{
        const ang=(i/count)*Math.PI*2 - Math.PI/2;
        const jr= r + (hash(d.id)%40)-20;
        nodes.push(makeNode(d, cx+Math.cos(ang)*jr, cy+Math.sin(ang)*jr, i));
      });
      break;
    }
    case"ring": {
      const r1=Math.min(W,H)*0.22, r2=Math.min(W,H)*0.38;
      others.forEach((d,i)=>{
        const ring = i%2===0 ? r1 : r2;
        const ang=(i/count)*Math.PI*2-Math.PI/2;
        nodes.push(makeNode(d, cx+Math.cos(ang)*ring, cy+Math.sin(ang)*ring, i));
      });
      break;
    }
    case"mesh": {
      const cols=Math.ceil(Math.sqrt(count+1));
      const step=Math.min(W/(cols+1), H/(cols+1));
      others.forEach((d,i)=>{
        const col=i%cols, row=Math.floor(i/cols);
        const ox=(-(cols-1)/2+col)*step;
        const oy=(-(Math.ceil(count/cols)-1)/2+row)*step;
        nodes.push(makeNode(d, cx+ox+(hash(d.id)%20)-10, cy+oy+(hash(d.id+"y")%20)-10, i));
      });
      break;
    }
    case"tree": {
      const levels={};
      others.forEach((d,i)=>{ const lv=Math.floor(Math.log2(i+2)); (levels[lv]=levels[lv]||[]).push(d); });
      const maxL=Math.max(...Object.keys(levels).map(Number));
      Object.entries(levels).forEach(([lv,arr])=>{
        const y=cy-Math.min(H*0.3,(maxL)*60)+(Number(lv)-1)*90;
        arr.forEach((d,i)=>{
          const x=cx+(i-(arr.length-1)/2)*Math.min(120, W/(arr.length+1));
          nodes.push(makeNode(d,x,y,i));
        });
      });
      break;
    }
    case"cluster": {
      const groups={};
      others.forEach(d=>{ (groups[d.type]=groups[d.type]||[]).push(d); });
      const gkeys=Object.keys(groups);
      const gr=Math.min(W,H)*0.3;
      gkeys.forEach((gk,gi)=>{
        const gang=(gi/gkeys.length)*Math.PI*2-Math.PI/2;
        const gcx=cx+Math.cos(gang)*gr;
        const gcy=cy+Math.sin(gang)*gr;
        const arr=groups[gk];
        arr.forEach((d,i)=>{
          const ar=(i/arr.length)*Math.PI*2;
          const ar2=60+hash(d.id)%30;
          nodes.push(makeNode(d, gcx+Math.cos(ar)*ar2, gcy+Math.sin(ar)*ar2, i));
        });
      });
      break;
    }
  }
  return nodes;
}

function makeNode(dev, x, y, idx, isCenter=false){
  const dt = DEVICE_TYPES[dev.type]||DEVICE_TYPES.unknown;
  const floatOff=(hash(dev.id)%60)/10;
  return {
    id:dev.id, dev,
    x, y,
    baseX:x, baseY:y,
    isCenter,
    color: dt.color,
    ring:  dt.ring,
    icon:  dt.icon,
    label: dt.label,
    floatPhase: floatOff,
    floatAmp: isCenter ? 4 : 2+(hash(dev.id+"amp")%6),
    floatSpeed: 0.5+(hash(dev.id+"spd")%10)/10,
    radius: isCenter ? 28 : 20+(hash(dev.id+"rad")%6),
    pulsePhase: hash(dev.id+"pp")%100/100,
    threat: dev.trust==="Unknown"||dev.type==="unknown",
    selected:false, hovered:false,
  };
}

function buildLinks(nodes){
  if(nodes.length===0) return [];
  const links=[];
  const center = nodes.find(n=>n.isCenter)||nodes[0];
  const others = nodes.filter(n=>!n.isCenter);

  if(S.layout==="mesh"){
    others.forEach((n,i)=>{
      links.push({a:center, b:n, strength:1});
      others.forEach((n2,j)=>{
        if(j>i && Math.abs(i-j)<=2) links.push({a:n, b:n2, strength:0.4});
      });
    });
  } else if(S.layout==="ring"){
    others.forEach(n=>links.push({a:center, b:n, strength:1}));
    others.forEach((n,i)=>{ links.push({a:n, b:others[(i+1)%others.length], strength:0.5}); });
  } else if(S.layout==="tree"){
    others.forEach((n,i)=>{
      const parent=i===0?center:others[Math.floor((i-1)/2)];
      if(parent) links.push({a:parent, b:n, strength:0.8});
    });
  } else if(S.layout==="cluster"){
    const groups={};
    others.forEach(n=>{ (groups[n.dev.type]=groups[n.dev.type]||[]).push(n); });
    Object.values(groups).forEach(arr=>{
      arr.forEach(n=>links.push({a:center, b:n, strength:0.6}));
      arr.forEach((n,i)=>{ if(i>0) links.push({a:arr[i-1], b:n, strength:0.35}); });
    });
  } else {
    others.forEach(n=>links.push({a:center, b:n, strength:1}));
    // random extras
    others.forEach((n,i)=>{
      if(i>0 && hash(n.id+"lnk")%3===0){
        links.push({a:n, b:others[hash(n.id+"lnk2")%others.length]||center, strength:0.25});
      }
    });
  }
  return links;
}

// â”€â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnParticles(){
  S.particles=[];
  const W=mapC.width, H=mapC.height;
  for(let i=0;i<80;i++){
    S.particles.push({
      x:Math.random()*W, y:Math.random()*H,
      vx:(Math.random()-.5)*0.4, vy:(Math.random()-.5)*0.4,
      life:Math.random(), maxLife:0.6+Math.random()*0.8,
      size:0.5+Math.random()*1.5,
      phase:Math.random()*Math.PI*2,
    });
  }
}

function spawnBeam(a, b){
  S.beams.push({ a, b, t:0, speed:0.004+Math.random()*0.006 });
}

function spawnBeams(){
  S.beams=[];
  S.links.forEach(lk=>{ if(Math.random()>.4) spawnBeam(lk.a, lk.b); });
}

function addActivity(msg, color="#00f0ff"){
  const now=new Date();
  const t=`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;
  S.activity.unshift({msg, color, t});
  S.activity=S.activity.slice(0,20);
  renderActivity();
}

function renderActivity(){
  const el=document.getElementById("activityFeed");
  el.innerHTML=S.activity.map(a=>`
    <div class="af-item">
      <div class="af-dot" style="background:${a.color};box-shadow:0 0 6px ${a.color};"></div>
      <div><div style="color:rgba(255,255,255,0.85);">${a.msg}</div><div class="af-time">${a.t}</div></div>
    </div>
  `).join("");
}

// â”€â”€â”€ VIEW TRANSFORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function project(wx, wy, W, H){
  const cx=W/2, cy=H/2;
  const dx=wx-cx, dy=wy-cy;
  // 3D rotation
  const rx=S.rotX*Math.PI/180;
  const rz=S.rotZ*Math.PI/180;
  // rotate around Z
  const x2=dx*Math.cos(rz)-dy*Math.sin(rz);
  const y2=dx*Math.sin(rz)+dy*Math.cos(rz);
  // rotate around X (perspective tilt)
  const y3=y2*Math.cos(rx);
  const z3=y2*Math.sin(rx);
  // perspective divide
  const fov=600;
  const scale=fov/(fov-z3*0.3);
  return {
    sx: cx+(x2*S.zoom*scale),
    sy: cy+(y3*S.zoom*scale),
    scale: scale*S.zoom,
    depth: z3,
  };
}

// â”€â”€â”€ BACKGROUND RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBg(t){
  const W=bgC.width, H=bgC.height;
  bctx.clearRect(0,0,W,H);
  bctx.fillStyle="#000";
  bctx.fillRect(0,0,W,H);

  if(S.fx.grid){
    const ph=getThemeHex();
    const sh=getSHex();
    bctx.save();
    bctx.globalAlpha=0.06;
    const step=50;
    for(let x=0;x<W;x+=step){
      bctx.beginPath();bctx.moveTo(x,0);bctx.lineTo(x,H);
      bctx.strokeStyle=ph;bctx.lineWidth=0.5;bctx.stroke();
    }
    for(let y=0;y<H;y+=step){
      bctx.beginPath();bctx.moveTo(0,y);bctx.lineTo(W,y);
      bctx.strokeStyle=sh;bctx.lineWidth=0.5;bctx.stroke();
    }
    bctx.restore();
  }

  // ambient stars
  bctx.save();
  bctx.globalAlpha=0.3;
  for(let i=0;i<60;i++){
    const sx=hash("sx"+i)*W/2147483647%W;
    const sy=hash("sy"+i)*H/2147483647%H;
    const r=(hash("sr"+i)%10)/10*1.2+0.2;
    const flicker=0.5+0.5*Math.sin(t*0.0008+i*1.3);
    bctx.beginPath();
    bctx.arc(sx,sy,r,0,Math.PI*2);
    bctx.fillStyle=`rgba(255,255,255,${0.2+0.4*flicker})`;
    bctx.fill();
  }
  bctx.restore();
}

// â”€â”€â”€ FX RENDER (particles, beams, ripples) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFx(t){
  const W=fxC.width, H=fxC.height;
  fctx.clearRect(0,0,W,H);

  const ph=getThemeHex();
  const sh=getSHex();
  const ah=getAHex();

  // heatmap
  if(S.fx.heatmap){
    S.nodes.forEach(n=>{
      const p=project(n.x+n.floatAmp*Math.sin(t*0.001*n.floatSpeed+n.floatPhase),
                      n.y+n.floatAmp*Math.cos(t*0.0013*n.floatSpeed+n.floatPhase), W, H);
      const r=n.radius*p.scale*2.5;
      const g=fctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r*4);
      const c=n.threat?"255,51,102":hexToRaw(ph);
      g.addColorStop(0,`rgba(${c},0.22)`);
      g.addColorStop(0.5,`rgba(${c},0.08)`);
      g.addColorStop(1,`rgba(${c},0)`);
      fctx.beginPath();fctx.arc(p.sx,p.sy,r*4,0,Math.PI*2);
      fctx.fillStyle=g;fctx.fill();
    });
  }

  // particles
  if(S.fx.particles){
    S.particles.forEach(p=>{
      p.x+=p.vx*S.animSpeed; p.y+=p.vy*S.animSpeed;
      p.life+=0.003*S.animSpeed;
      if(p.life>p.maxLife){ p.life=0; p.x=Math.random()*W; p.y=Math.random()*H; }
      const alpha=Math.sin(p.life/p.maxLife*Math.PI)*0.5;
      const s=p.size*(0.7+0.3*Math.sin(t*0.002+p.phase));
      fctx.beginPath();fctx.arc(p.x,p.y,s,0,Math.PI*2);
      fctx.fillStyle=`rgba(${hexToRaw(ah)},${alpha})`;fctx.fill();
    });
  }

  // data beams along links
  if(S.fx.beams){
    S.beams.forEach((b,i)=>{
      b.t+=b.speed*S.animSpeed;
      if(b.t>1){ b.t=0; b.speed=0.004+Math.random()*0.006; }
      const pa=project(b.a.x+b.a.floatAmp*Math.sin(t*.001*b.a.floatSpeed+b.a.floatPhase),
                       b.a.y+b.a.floatAmp*Math.cos(t*.0013*b.a.floatSpeed+b.a.floatPhase),W,H);
      const pb2=project(b.b.x+b.b.floatAmp*Math.sin(t*.001*b.b.floatSpeed+b.b.floatPhase),
                        b.b.y+b.b.floatAmp*Math.cos(t*.0013*b.b.floatSpeed+b.b.floatPhase),W,H);
      const bx=pa.sx+(pb2.sx-pa.sx)*b.t;
      const by=pa.sy+(pb2.sy-pa.sy)*b.t;
      const tr=b.a.threat||b.b.threat?"255,51,102":hexToRaw(ph);

      // glow trail
      for(let j=0;j<5;j++){
        const jt=b.t-j*0.04;
        if(jt<0) continue;
        const jx=pa.sx+(pb2.sx-pa.sx)*jt;
        const jy=pa.sy+(pb2.sy-pa.sy)*jt;
        fctx.beginPath();fctx.arc(jx,jy,4-j*0.5,0,Math.PI*2);
        fctx.fillStyle=`rgba(${tr},${0.5-j*0.08})`;fctx.fill();
      }
      // beam head
      fctx.beginPath();fctx.arc(bx,by,5,0,Math.PI*2);
      fctx.fillStyle=`rgba(${tr},0.95)`;fctx.fill();
      fctx.beginPath();fctx.arc(bx,by,10,0,Math.PI*2);
      fctx.fillStyle=`rgba(${tr},0.25)`;fctx.fill();
    });
  }

  // ripples
  S.ripples=S.ripples.filter(r=>r.t<1);
  S.ripples.forEach(r=>{
    r.t+=0.025*S.animSpeed;
    const p2=project(r.x,r.y,W,H);
    const rr=r.t*r.maxR*p2.scale;
    fctx.beginPath();fctx.arc(p2.sx,p2.sy,rr,0,Math.PI*2);
    fctx.strokeStyle=`rgba(${hexToRaw(ph)},${(1-r.t)*0.8})`;
    fctx.lineWidth=2*(1-r.t);fctx.stroke();
    fctx.beginPath();fctx.arc(p2.sx,p2.sy,rr*0.5,0,Math.PI*2);
    fctx.strokeStyle=`rgba(${hexToRaw(ph)},${(1-r.t)*0.4})`;
    fctx.lineWidth=1;fctx.stroke();
  });

  // radar sweep at center
  if(S.scanActive){
    const sw=S.scanAnim%Math.PI*2;
    const cnode=S.nodes.find(n=>n.isCenter);
    if(cnode){
      const cp=project(cnode.x,cnode.y,W,H);
      const cr=Math.min(W,H)*0.5*S.zoom;
      fctx.save();
      fctx.translate(cp.sx,cp.sy);
      const grad=fctx.createConicalGradient?.(sw,sw+0.8)||null;
      fctx.beginPath();
      fctx.moveTo(0,0);
      fctx.arc(0,0,cr,sw,sw+Math.PI*0.5);
      fctx.closePath();
      fctx.fillStyle=`rgba(${hexToRaw(ph)},0.05)`;fctx.fill();
      fctx.beginPath();fctx.moveTo(0,0);
      fctx.lineTo(Math.cos(sw)*cr, Math.sin(sw)*cr);
      fctx.strokeStyle=`rgba(${hexToRaw(ph)},0.7)`;fctx.lineWidth=2;fctx.stroke();
      fctx.restore();
      S.scanAnim+=0.025*S.animSpeed;
    }
  }
}

// â”€â”€â”€ MAIN MAP RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMap(t){
  const W=mapC.width, H=mapC.height;
  mctx.clearRect(0,0,W,H);

  const ph=getThemeHex();
  const sh=getSHex();
  const ah=getAHex();

  if(!S.nodes.length) return;

  // sort by depth for proper layering
  const projected=S.nodes.map(n=>{
    const fx=n.x+n.floatAmp*Math.sin(t*0.001*n.floatSpeed+n.floatPhase);
    const fy=n.y+n.floatAmp*Math.cos(t*0.0013*n.floatSpeed+n.floatPhase);
    const p=project(fx,fy,W,H);
    return {...n, _fx:fx, _fy:fy, _px:p.sx, _py:p.sy, _scale:p.scale, _depth:p.depth};
  }).sort((a,b)=>a._depth-b._depth);

  const projMap={};
  projected.forEach(n=>projMap[n.id]={sx:n._px,sy:n._py,scale:n._scale});

  // draw links first
  S.links.forEach(lk=>{
    const pa=projMap[lk.a.id], pb=projMap[lk.b.id];
    if(!pa||!pb) return;
    const isT=lk.a.threat||lk.b.threat;
    const baseC=isT?"255,51,102":hexToRaw(ph);
    const pulse=0.3+0.2*Math.sin(t*0.002+lk.a.floatPhase);

    // link shadow glow
    mctx.beginPath();mctx.moveTo(pa.sx,pa.sy);mctx.lineTo(pb.sx,pb.sy);
    mctx.strokeStyle=`rgba(${baseC},${lk.strength*0.12})`;
    mctx.lineWidth=6;mctx.stroke();
    // link core
    mctx.beginPath();mctx.moveTo(pa.sx,pa.sy);mctx.lineTo(pb.sx,pb.sy);
    const grad=mctx.createLinearGradient(pa.sx,pa.sy,pb.sx,pb.sy);
    grad.addColorStop(0,`rgba(${baseC},${lk.strength*(0.4+pulse)})`);
    grad.addColorStop(0.5,`rgba(${hexToRaw(ah)},${lk.strength*0.6})`);
    grad.addColorStop(1,`rgba(${hexToRaw(sh)},${lk.strength*(0.4+pulse)})`);
    mctx.strokeStyle=grad;mctx.lineWidth=1.5;mctx.stroke();
  });

  // draw nodes
  projected.forEach(n=>{
    const px=n._px, py=n._py, sc=n._scale;
    const r=n.radius*sc;
    const pulse=0.5+0.5*Math.sin(t*0.002*n.floatSpeed+n.pulsePhase*Math.PI*2);
    const isSelected=S.selectedId===n.id;
    const isHovered=S.hoveredId===n.id;

    // outer halo
    mctx.beginPath();mctx.arc(px,py,r*2.4,0,Math.PI*2);
    const halo=mctx.createRadialGradient(px,py,r*0.5,px,py,r*2.4);
    const nc=n.threat?"255,51,102":hexToRaw(n.color);
    halo.addColorStop(0,`rgba(${nc},${0.18*pulse})`);
    halo.addColorStop(1,`rgba(${nc},0)`);
    mctx.fillStyle=halo;mctx.fill();

    // selection ring
    if(isSelected||isHovered){
      mctx.beginPath();mctx.arc(px,py,r*1.7+2*pulse,0,Math.PI*2);
      mctx.strokeStyle=`rgba(${nc},${isSelected?.9:.5})`;
      mctx.lineWidth=isSelected?2.5:1.5;mctx.stroke();
      if(isSelected){
        mctx.beginPath();mctx.arc(px,py,r*2.2+4*pulse,0,Math.PI*2);
        mctx.strokeStyle=`rgba(${nc},0.3)`;mctx.lineWidth=1;mctx.stroke();
      }
    }

    // threat extra ring animation
    if(n.threat){
      mctx.beginPath();mctx.arc(px,py,r*(1.3+0.4*pulse),0,Math.PI*2);
      mctx.strokeStyle=`rgba(255,51,102,${0.5+0.3*pulse})`;
      mctx.lineWidth=1.5;mctx.setLineDash([4,4]);
      mctx.lineDashOffset=-t*0.04;mctx.stroke();mctx.setLineDash([]);
    }

    // center-node orbit rings
    if(n.isCenter){
      [1.8,2.6,3.5].forEach((m,oi)=>{
        mctx.beginPath();mctx.arc(px,py,r*m,0,Math.PI*2);
        mctx.strokeStyle=`rgba(${hexToRaw(ph)},${0.12-oi*0.03})`;
        mctx.lineWidth=0.8;mctx.stroke();
        // tick marks
        for(let ti=0;ti<12;ti++){
          const ta=(ti/12)*Math.PI*2+t*0.0003*(oi+1)*S.animSpeed;
          mctx.beginPath();
          mctx.arc(px+Math.cos(ta)*r*m,py+Math.sin(ta)*r*m,1.5,0,Math.PI*2);
          mctx.fillStyle=`rgba(${hexToRaw(ph)},${0.4-oi*0.1})`;mctx.fill();
        }
      });
    }

    // node background circle
    mctx.beginPath();mctx.arc(px,py,r,0,Math.PI*2);
    const nodeGrad=mctx.createRadialGradient(px-r*0.3,py-r*0.3,r*0.1,px,py,r);
    nodeGrad.addColorStop(0,"rgba(40,40,40,0.95)");
    nodeGrad.addColorStop(0.6,"rgba(10,10,10,0.9)");
    nodeGrad.addColorStop(1,"rgba(0,0,0,0.85)");
    mctx.fillStyle=nodeGrad;mctx.fill();

    // node border
    mctx.beginPath();mctx.arc(px,py,r,0,Math.PI*2);
    const borderGrad=mctx.createLinearGradient(px-r,py-r,px+r,py+r);
    borderGrad.addColorStop(0,n.color);
    borderGrad.addColorStop(1,n.ring);
    mctx.strokeStyle=borderGrad;
    mctx.lineWidth=n.isCenter?2.5:1.8;mctx.stroke();

    // inner glow
    mctx.beginPath();mctx.arc(px,py,r*0.7,0,Math.PI*2);
    const innerGlow=mctx.createRadialGradient(px,py,0,px,py,r*0.7);
    innerGlow.addColorStop(0,`rgba(${hexToRaw(n.color)},0.15)`);
    innerGlow.addColorStop(1,`rgba(${hexToRaw(n.color)},0)`);
    mctx.fillStyle=innerGlow;mctx.fill();

    // icon text (emoji)
    mctx.save();
    mctx.font=`${r*0.95}px serif`;
    mctx.textAlign="center";mctx.textBaseline="middle";
    mctx.shadowColor=n.color;mctx.shadowBlur=8;
    mctx.fillText(n.icon,px,py+1);
    mctx.restore();

    // status dot (online indicator)
    const dotR=r*0.22;
    const dotX=px+r*0.72, dotY=py-r*0.72;
    mctx.beginPath();mctx.arc(dotX,dotY,dotR,0,Math.PI*2);
    const statusColor=n.dev.online?"#00ff88":n.threat?"#ff3366":"#888888";
    mctx.fillStyle=statusColor;mctx.fill();
    if(n.dev.online){
      mctx.beginPath();mctx.arc(dotX,dotY,dotR*(1.5+0.5*pulse),0,Math.PI*2);
      mctx.strokeStyle=`rgba(0,255,136,${0.4*pulse})`;mctx.lineWidth=1;mctx.stroke();
    }

    // label
    if(S.fx.labels){
      const labelY=py+r+12*sc;
      mctx.save();
      mctx.globalAlpha=0.5+0.4*sc;
      // name
      mctx.font=`${Math.max(9,11*sc)}px "Share Tech Mono",monospace`;
      mctx.textAlign="center";mctx.textBaseline="top";
      mctx.shadowColor=n.color;mctx.shadowBlur=6;
      mctx.fillStyle="rgba(255,255,255,0.9)";
      mctx.fillText(n.dev.name, px, labelY);
      // IP
      mctx.font=`${Math.max(7,9*sc)}px "Share Tech Mono",monospace`;
      mctx.fillStyle=n.color;mctx.shadowBlur=4;
      mctx.fillText(n.dev.ip, px, labelY+14*sc);
      mctx.restore();
    }
  });
}

// â”€â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameCount=0;
function loop(ts){
  const dt=ts-S.lastFrame; S.lastFrame=ts;
  S.fpsSamples.push(1000/dt);
  if(S.fpsSamples.length>30) S.fpsSamples.shift();
  frameCount++;

  if(S.autoRotate){ S.rotZ+=0.12*S.animSpeed*S.autoDir; S.rotZ%=360; }

  // momentum
  if(!S.dragging&&(Math.abs(S.momentum.x)>0.05||Math.abs(S.momentum.y)>0.05)){
    S.rotZ+=S.momentum.x;
    S.rotX=clamp(S.rotX-S.momentum.y,18,85);
    S.momentum.x*=0.90; S.momentum.y*=0.90;
  }

  // float nodes
  S.nodes.forEach(n=>{
    n.x=n.baseX+n.floatAmp*Math.sin(ts*0.001*n.floatSpeed+n.floatPhase)*0.5;
    n.y=n.baseY+n.floatAmp*Math.cos(ts*0.0013*n.floatSpeed+n.floatPhase)*0.5;
  });

  renderBg(ts);
  renderFx(ts);
  renderMap(ts);
  updateHudInfo();

  if(frameCount%30===0){
    const fps=Math.round(S.fpsSamples.reduce((a,b)=>a+b,0)/S.fpsSamples.length);
    document.getElementById("sbFps").textContent=`FPS: ${fps}`;
    document.getElementById("sbTime").textContent=new Date().toLocaleTimeString();
  }

  requestAnimationFrame(loop);
}

// â”€â”€â”€ HUD INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHudInfo(){
  document.getElementById("infoRotX").textContent=`${Math.round(S.rotX)}Â°`;
  document.getElementById("infoRotZ").textContent=`${Math.round(S.rotZ%360)}Â°`;
  document.getElementById("infoZoom").textContent=`${S.zoom.toFixed(2)}Ã—`;
  document.getElementById("infoNodes").textContent=S.nodes.length;
  document.getElementById("infoMode").textContent=S.layout.toUpperCase();
  document.getElementById("compass-needle").style.transform=`rotate(${S.rotZ}deg)`;
  const zp=clamp((S.zoom-0.3)/2.2*100,0,100);
  document.getElementById("zoomFill").style.width=zp+"%";
  document.getElementById("zoomHud").firstChild.textContent=`${Math.round(S.zoom*100)}%`;
}

function updateStats(){
  const devs=filteredDevices();
  const online=devs.filter(d=>d.online).length;
  const threats=devs.filter(d=>d.trust==="Unknown"||d.type==="unknown").length;
  document.getElementById("scTotal").textContent=devs.length;
  document.getElementById("scOnline").textContent=online;
  document.getElementById("scThreats").textContent=threats;
  document.getElementById("scLinks").textContent=S.links.length;
}

// â”€â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTooltip(node, mx, my){
  const tt=document.getElementById("tooltip");
  const dev=node.dev;
  const dt=DEVICE_TYPES[dev.type]||DEVICE_TYPES.unknown;
  document.getElementById("ttIcon").textContent=dt.icon;
  document.getElementById("ttName").textContent=dev.name;
  document.getElementById("ttType").textContent=`${dt.label} â€¢ ${dev.vendor}`;
  document.getElementById("ttKv").innerHTML=`
    <span class="tt-k">IP</span><span class="tt-v">${dev.ip}</span>
    <span class="tt-k">MAC</span><span class="tt-v">${dev.mac}</span>
    <span class="tt-k">Trust</span><span class="tt-v" style="color:${dev.trust==="Trusted"?"#00ff88":"#ff3366"}">${dev.trust}</span>
    <span class="tt-k">Vendor</span><span class="tt-v">${dev.vendor}</span>
  `;
  const statusColor=dev.online?"#00ff88":"#888888";
  document.getElementById("ttDot").style.background=statusColor;
  document.getElementById("ttDot").style.boxShadow=`0 0 8px ${statusColor}`;
  document.getElementById("ttStatusText").textContent=dev.online?"Online":"Offline";
  tt.style.left=(mx+16)+"px"; tt.style.top=(my-10)+"px";
  tt.classList.add("show");
}
function hideTooltip(){
  document.getElementById("tooltip").classList.remove("show");
}

// â”€â”€â”€ MOUSE / TOUCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastMX=0,lastMY=0,lastPinch=null;
const ptrs=new Map();

mapC.addEventListener("pointerdown",e=>{
  ptrs.set(e.pointerId,{x:e.clientX,y:e.clientY});
  mapC.setPointerCapture(e.pointerId);
  S.dragging=true; S.momentum={x:0,y:0};
  lastMX=e.clientX; lastMY=e.clientY;
  if(ptrs.size===2) lastPinch=null;
});

mapC.addEventListener("pointermove",e=>{
  const rect=mapC.getBoundingClientRect();
  const mx=e.clientX-rect.left, my=e.clientY-rect.top;

  // hover detection
  if(ptrs.size===0){
    const hit=hitTest(mx,my);
    if(hit?.id!==S.hoveredId){
      S.hoveredId=hit?.id||null;
      if(hit) showTooltip(hit, mx, my);
      else hideTooltip();
      mapC.style.cursor=hit?"pointer":"grab";
    }
  }

  if(!ptrs.has(e.pointerId)) return;
  const prev=ptrs.get(e.pointerId);
  ptrs.set(e.pointerId,{x:e.clientX,y:e.clientY});

  if(ptrs.size===1){
    const dx=e.clientX-prev.x, dy=e.clientY-prev.y;
    S.rotZ+=dx*0.35; S.rotX=clamp(S.rotX-dy*0.3,18,85);
    S.momentum.x=dx*0.6; S.momentum.y=dy*0.6;
    hideTooltip();
  }
  if(ptrs.size===2){
    const pts=[...ptrs.values()];
    const dist=Math.hypot(pts[0].x-pts[1].x,pts[0].y-pts[1].y);
    if(lastPinch!==null){ S.zoom=clamp(S.zoom+(dist-lastPinch)*0.003,0.3,3); }
    lastPinch=dist;
  }
});

mapC.addEventListener("pointerup",e=>{
  ptrs.delete(e.pointerId);
  if(ptrs.size<2) lastPinch=null;
  if(ptrs.size===0) S.dragging=false;
  // click â†’ select
  if(Math.abs(e.clientX-lastMX)<5&&Math.abs(e.clientY-lastMY)<5){
    const rect=mapC.getBoundingClientRect();
    const hit=hitTest(e.clientX-rect.left,e.clientY-rect.top);
    if(hit){
      S.selectedId=S.selectedId===hit.id?null:hit.id;
      S.ripples.push({x:hit.x,y:hit.y,t:0,maxR:80});
      if(S.selectedId) addActivity(`Selected: ${hit.dev.name} (${hit.dev.ip})`, hit.color);
    } else { S.selectedId=null; }
  }
});

mapC.addEventListener("pointercancel",e=>{ ptrs.delete(e.pointerId); S.dragging=false; });

mapC.addEventListener("wheel",e=>{
  e.preventDefault();
  S.zoom=clamp(S.zoom-e.deltaY*0.001,0.3,3);
},{passive:false});

function hitTest(mx,my){
  const W=mapC.width,H=mapC.height;
  let best=null,bestDist=Infinity;
  S.nodes.forEach(n=>{
    const p=project(n.x,n.y,W,H);
    const d=Math.hypot(mx-p.sx,my-p.sy);
    const hit=n.radius*p.scale*1.5;
    if(d<hit&&d<bestDist){ bestDist=d; best=n; }
  });
  return best;
}

// â”€â”€â”€ UI CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll("[data-mode]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    S.layout=btn.dataset.mode;
    document.querySelectorAll("[data-mode]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    buildGraph(); spawnBeams();
    addActivity(`Layout â†’ ${S.layout.toUpperCase()}`);
  });
});

document.querySelectorAll("[data-view]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    S.view=btn.dataset.view;
    document.querySelectorAll("[data-view]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    if(S.view==="top"){S.rotX=0;S.rotZ=0;}
    else if(S.view==="side"){S.rotX=0;S.rotZ=-90;}
    else {S.rotX=54;S.rotZ=-12;}
  });
});

document.querySelectorAll("[data-filter]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    S.filter=btn.dataset.filter;
    document.querySelectorAll("[data-filter]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    buildGraph(); spawnBeams();
    addActivity(`Filter â†’ ${S.filter.toUpperCase()}`);
  });
});

document.querySelectorAll("[data-fx]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const k=btn.dataset.fx;
    S.fx[k]=!S.fx[k];
    btn.classList.toggle("active",S.fx[k]);
    addActivity(`FX ${k} ${S.fx[k]?"ON":"OFF"}`);
  });
});

document.querySelectorAll("[data-theme]").forEach(el=>{
  el.addEventListener("click",()=>{
    S.theme=el.dataset.theme;
    document.getElementById("app").dataset.theme=S.theme;
    document.querySelectorAll("[data-theme]").forEach(e=>e.classList.remove("active"));
    el.classList.add("active");
    addActivity(`Theme â†’ ${S.theme.toUpperCase()}`);
  });
});

document.querySelectorAll("[data-speed]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    S.animSpeed=parseFloat(btn.dataset.speed);
    document.querySelectorAll("[data-speed]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
  });
});

document.getElementById("btnScan").addEventListener("click",()=>{
  S.scanActive=!S.scanActive; S.scanAnim=0;
  document.getElementById("sbStatus").textContent=S.scanActive?"Scanning networkâ€¦":"Scan complete";
  addActivity(S.scanActive?"Scan started":"Scan complete",S.scanActive?"#ffaa00":"#00ff88");
  if(S.scanActive){
    setTimeout(()=>{ S.scanActive=false; document.getElementById("sbStatus").textContent="Ready"; },8000);
  }
});

document.getElementById("btnReset").addEventListener("click",()=>{
  S.rotX=54; S.rotZ=-12; S.zoom=1; S.momentum={x:0,y:0};
});

document.getElementById("btnAutoRotate").addEventListener("click",function(){
  S.autoRotate=!S.autoRotate;
  this.classList.toggle("active",S.autoRotate);
  addActivity(`Auto-rotate ${S.autoRotate?"ON":"OFF"}`);
});

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hash(s){
  let h=2166136261;
  for(let i=0;i<s.length;i++){
    h^=s.charCodeAt(i);
    h+=h<<1+h<<4+h<<7+h<<8+h<<24;
  }
  return h>>>0;
}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function hexToRaw(hex){
  const h=hex.trim().replace("#","");
  return `${parseInt(h.slice(0,2),16)},${parseInt(h.slice(2,4),16)},${parseInt(h.slice(4,6),16)}`;
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init(){
  resize();
  spawnParticles();
  buildGraph();
  spawnBeams();

  // add initial activity
  setTimeout(()=>addActivity("System initialized","#00f0ff"),300);
  setTimeout(()=>addActivity(`Loaded ${S.devices.length} devices`,getThemeHex()),600);
  S.devices.filter(d=>d.online).forEach((d,i)=>{
    setTimeout(()=>addActivity(`${d.name} online (${d.ip})`, DEVICE_TYPES[d.type]?.color||"#00f0ff"),900+i*120);
  });
  S.devices.filter(d=>d.trust==="Unknown").forEach((d,i)=>{
    setTimeout(()=>addActivity(`âš  THREAT: ${d.name} (${d.ip})`,"#ff3366"),2000+i*300);
  });

  requestAnimationFrame(loop);
}

window.addEventListener("load", init);

// Expose for external integration
window.nnUpdateDiscoveryMap=function(deviceList){
  if(Array.isArray(deviceList)) S.devices=deviceList;
  buildGraph(); spawnBeams();
};

// Update beams periodically
setInterval(()=>{ spawnBeams(); }, 6000);
</script>
</body>
</html>
