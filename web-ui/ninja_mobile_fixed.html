<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Network Control</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#000;
      --panel: rgba(10, 11, 16, 0.72);
      --panel2: rgba(0,0,0,0.55);

      --neon-cyan:#00f0ff;
      --neon-purple:#b967ff;
      --neon-mint:#78ffdc;
      --neon-pink: var(--neon-mint);
      --neon-yellow: var(--neon-cyan);
      --ok: var(--neon-mint);
      --warn: var(--neon-cyan);
      --bad: var(--neon-purple);

      --border-cyan: rgba(0, 240, 255, 0.42);
      --border-purple: rgba(185, 103, 255, 0.42);
      --border-pink: rgba(120, 255, 220, 0.38);

      --shadow-cyan: 0 0 22px rgba(0,240,255,0.28);
      --shadow-purple: 0 0 22px rgba(185,103,255,0.28);
      --shadow-mix: 0 0 26px rgba(185,103,255,0.22), 0 0 22px rgba(0,240,255,0.18);

      --radius: 16px;
      --radius-sm: 12px;

      --gap: 12px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --tabbar-h: 74px;
      --topbar-h: 96px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; }
    body{
      background: var(--bg0);
      color: rgba(255,255,255,0.92);
      font-family: "Share Tech Mono", monospace;
      overflow-x:hidden;
    }

    /* subtle neon grid + scanlines */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        linear-gradient(rgba(185,103,255,0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,240,255,0.06) 1px, transparent 1px);
      background-size: 22px 22px;
      opacity: 0.35;
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(120,255,220,0.08), rgba(0,240,255,0.06), rgba(185,103,255,0.08));
      background-size: 100% 2px, 3px 100%;
      opacity: .52;
      z-index:-1;
      animation: flicker .15s infinite;
    }
    @keyframes flicker{
      0% { opacity: 0.25; } 20% { opacity: 0.85; } 40% { opacity: 0.35; }
      60% { opacity: 0.95; } 80% { opacity: 0.30; } 100% { opacity: 0.55; }
    }

    /* Video Header - positioned at the very top */
    .video-header{
      position: relative;
      width: 100%;
      height: clamp(120px, 20vh, 180px);
      overflow: hidden;
      z-index: 10;
    }
    .video-header video{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .video-overlay{
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
      display: flex;
      align-items: flex-end;
      padding: 12px;
    }
    .video-title{
      color: var(--neon-cyan);
      font-family: "Orbitron", sans-serif;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 2px;
      text-shadow: 0 0 10px var(--neon-cyan);
      text-transform: uppercase;
    }

    .app{
      min-height:100dvh;
      padding-top: calc(var(--safe-top));
      padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom));
    }

    /* Top chrome - positioned after video */
    .topbar{
      position:sticky;
      top:0;
      z-index:1000;
      height: calc(var(--topbar-h) + var(--safe-top));
      padding: 0 12px;
      background: #020205;
      border-bottom: 1px solid var(--border-purple);
      box-shadow: var(--shadow-purple);
      overflow:hidden;
    }
    .topbar-inner{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding-top: var(--safe-top);
    }
    .brand,
    .topbar-actions{
      position:relative;
      z-index:1;
    }
    .topbar-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
      flex:1;
    }
    .brand-badge{
      width:38px; height:38px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
      box-shadow: 0 0 14px rgba(0,240,255,0.35);
      display:grid; place-items:center;
      color:#000; font-weight:900;
      font-family:"Orbitron", sans-serif;
      letter-spacing:0.5px;
    }
    .brand-title{
      font-family:"Orbitron", sans-serif;
      font-weight:700;
      letter-spacing:1.5px;
      font-size: 14px;
      line-height:1.1;
      color: rgba(255,255,255,0.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brand-sub{
      font-size: 11px;
      color: rgba(255,255,255,0.65);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.9);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font: inherit;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{ transform: scale(0.97); }

    .btn-primary{
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
      color:#000;
      border-color: rgba(0,0,0,0.1);
      box-shadow: var(--shadow-mix);
      font-weight:800;
      letter-spacing:0.8px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Content */
    main{
      padding: 12px;
      padding-top: 14px;
    }

    .tab-page{
      display:none;
      animation: fadeIn .14s ease;
    }
    .tab-page.active{ display:block; }
    @keyframes fadeIn{ from{ opacity:.35; transform: translateY(4px);} to{ opacity:1; transform:none; } }

    h2{
      font-family:"Orbitron", sans-serif;
      font-weight:700;
      letter-spacing:1.6px;
      text-transform: uppercase;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
      margin: 6px 0 10px 2px;
      text-shadow: 0 0 12px rgba(185,103,255,0.22);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
    }
    @media (min-width: 560px){
      .grid-2{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: var(--panel);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-purple);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow-purple);
      position: relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:active{ transform: translateY(-2px); box-shadow: 0 0 28px rgba(185,103,255,0.34); border-color: rgba(0,240,255,0.35); }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, transparent 35%, rgba(0,240,255,0.08) 55%, transparent 75%);
      opacity:.35;
      pointer-events:none;
    }

    /* Bottom nav (tabs) */
    .tabbar{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index:1000;
      padding: 8px 10px calc(8px + var(--safe-bottom)) 10px;
      background: linear-gradient(135deg, rgba(0,240,255,0.12) 0%, rgba(185,103,255,0.12) 50%, rgba(229,98,192,0.10) 100%);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border-purple);
      box-shadow: 0 -10px 24px rgba(185,103,255,0.16);
    }
    .tabbar-inner{
      display:flex;
      gap: 6px;
      align-items:stretch;
      justify-content:space-between;
    }
    .tabbtn{
      flex:1;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 10px 8px;
      cursor:pointer;
      color: rgba(255,255,255,0.70);
      font: inherit;
      display:flex;
      flex-direction:column;
      gap: 4px;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition: background .2s ease, border-color .2s ease, transform .08s ease;
    }
    .tabbtn:active{ transform: scale(0.98); }
    .tabbtn.active{
      color: rgba(255,255,255,0.95);
      border-color: rgba(0,240,255,0.22);
      background: rgba(0,240,255,0.10);
      box-shadow: 0 0 16px rgba(0,240,255,0.12);
    }
    .tabbtn .ticon{ font-size: 18px; line-height: 1; }
    .tabbtn .tlabel{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-family:"Orbitron", sans-serif;
      font-weight: 700;
    }

    /* Error display */
    .error-toast{
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(185,103,255,0.9);
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      z-index: 9999;
      display: none;
      animation: slideDown 0.3s ease;
    }
    .error-toast.show{ display: block; }
    @keyframes slideDown{ from{ transform: translateY(-100%); } to{ transform: translateY(0); } }

    /* Loading states */
    .loading{
      opacity: 0.6;
      pointer-events: none;
    }
  </style>

</head>

<body>
  <!-- Video Header at the very top -->
  <div class="video-header">
    <video autoplay muted loop playsinline>
      <source src="/ui/assets/ninja_header.mp4" type="video/mp4">
      <source src="/ui/ninja_header.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div class="video-overlay">
      <div class="video-title">Network Ninja</div>
    </div>
  </div>

  <div class="app">
    <!-- Top chrome -->
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-badge">NN</div>
          <div>
            <div class="brand-title">Network Ninja</div>
            <div class="brand-sub">Mobile Control</div>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="btn btn-primary" id="scanBtn">
            <span>üîç</span>
            Scan Network
          </button>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <main>
      <!-- Dashboard Tab -->
      <div class="tab-page active" id="tab-dashboard">
        <h2>Network Overview</h2>
        
        <div class="grid grid-2">
          <div class="card">
            <div class="card-head">
              <div class="card-title">Devices Found</div>
              <div class="pill" id="device-count">0</div>
            </div>
            <div class="big" id="device-total">0</div>
            <div class="muted">Total network devices</div>
          </div>
          
          <div class="card">
            <div class="card-head">
              <div class="card-title">Online Now</div>
              <div class="pill ok" id="online-count">0</div>
            </div>
            <div class="big" id="online-total">0</div>
            <div class="muted">Active connections</div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <div class="card-title">Recent Devices</div>
          </div>
          <div id="device-list">
            <div class="muted">No devices found. Click "Scan Network" to discover devices.</div>
          </div>
        </div>
      </div>

      <!-- Devices Tab -->
      <div class="tab-page" id="tab-devices">
        <h2>Device List</h2>
        <div id="devices-content">
          <div class="muted">Loading devices...</div>
        </div>
      </div>

      <!-- Metrics Tab -->
      <div class="tab-page" id="tab-metrics">
        <h2>System Metrics</h2>
        <div id="metrics-content">
          <div class="muted">Loading metrics...</div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div class="tab-page" id="tab-logs">
        <h2>Activity Logs</h2>
        <div id="logs-content">
          <div class="muted">Connecting to log stream...</div>
        </div>
      </div>
    </main>

    <!-- Bottom navigation -->
    <div class="tabbar">
      <div class="tabbar-inner">
        <button class="tabbtn active" data-tab="dashboard">
          <div class="ticon">üè†</div>
          <div class="tlabel">Dashboard</div>
        </button>
        <button class="tabbtn" data-tab="devices">
          <div class="ticon">üì±</div>
          <div class="tlabel">Devices</div>
        </button>
        <button class="tabbtn" data-tab="metrics">
          <div class="ticon">üìä</div>
          <div class="tlabel">Metrics</div>
        </button>
        <button class="tabbtn" data-tab="logs">
          <div class="ticon">üìã</div>
          <div class="tlabel">Logs</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Error toast -->
  <div class="error-toast" id="error-toast"></div>

  <script>
    // Global state
    let authToken = localStorage.getItem('authToken');
    let devices = [];
    let metrics = {};
    let logStream = null;

    // API base URL (support file:// origins)
    const API_BASE = (() => {
      try {
        if (location && location.origin && location.origin !== 'null') return location.origin;
      } catch (_) {}
      return 'http://127.0.0.1:8787';
    })();

    // Error handling
    function showError(message) {
      const toast = document.getElementById('error-toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 5000);
    }

    // API calls with error handling
    async function apiCall(endpoint, options = {}) {
      try {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };
        
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        const text = await response.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) { data = text; }

        if (!response.ok) {
          if (response.status === 401 && endpoint !== '/api/v1/auth/login') {
            // Token expired, try to re-authenticate
            authToken = null;
            localStorage.removeItem('authToken');
            await authenticate();
            return apiCall(endpoint, options);
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return data;
      } catch (error) {
        showError(`API Error: ${error.message}`);
        throw error;
      }
    }

    // Authentication
    async function authenticate() {
      if (authToken) return true;
      
      try {
        const response = await apiCall('/api/v1/auth/login', {
          method: 'POST',
          body: JSON.stringify({
            username: 'ninja',
            password: 'neon'
          })
        });

        if (response && response.token) {
          authToken = response.token;
          localStorage.setItem('authToken', authToken);
          return true;
        }
      } catch (error) {
        showError('Authentication failed');
      }
      return false;
    }

    // Network scanning
    async function scanNetwork() {
      const scanBtn = document.getElementById('scanBtn');
      scanBtn.classList.add('loading');
      scanBtn.textContent = 'Scanning...';

      try {
        const results = await apiCall('/api/v1/discovery/scan', {
          method: 'POST',
          body: JSON.stringify({})
        });

        devices = results || [];
        updateDeviceDisplay();
        showError(`Scan complete: ${devices.length} devices found`);
      } catch (error) {
        showError('Scan failed: ' + error.message);
      } finally {
        scanBtn.classList.remove('loading');
        scanBtn.innerHTML = '<span>üîç</span> Scan Network';
      }
    }

    // Update device display
    function updateDeviceDisplay() {
      const deviceTotal = document.getElementById('device-total');
      const deviceCount = document.getElementById('device-count');
      const onlineTotal = document.getElementById('online-total');
      const onlineCount = document.getElementById('online-count');
      const deviceList = document.getElementById('device-list');

      const total = devices.length;
      const online = devices.filter(d => d.online).length;

      deviceTotal.textContent = total;
      deviceCount.textContent = total;
      onlineTotal.textContent = online;
      onlineCount.textContent = online;

      if (devices.length === 0) {
        deviceList.innerHTML = '<div class="muted">No devices found. Click "Scan Network" to discover devices.</div>';
        return;
      }

      deviceList.innerHTML = devices.slice(0, 5).map(device => `
        <div class="card" style="margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold; color: var(--neon-cyan);">
                ${device.hostname || device.ip}
              </div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                ${device.ip} ${device.mac ? '| ' + device.mac : ''}
              </div>
            </div>
            <div class="pill ${device.online ? 'ok' : 'bad'}">
              ${device.online ? 'Online' : 'Offline'}
            </div>
          </div>
        </div>
      `).join('');
    }

    // Load metrics
    async function loadMetrics() {
      try {
        metrics = await apiCall('/api/v1/metrics');
        updateMetricsDisplay();
      } catch (error) {
        document.getElementById('metrics-content').innerHTML = 
          '<div class="muted">Failed to load metrics</div>';
      }
    }

    // Update metrics display
    function updateMetricsDisplay() {
      const content = document.getElementById('metrics-content');
      content.innerHTML = `
        <div class="grid">
          <div class="card">
            <div class="card-head">
              <div class="card-title">System Uptime</div>
            </div>
            <div class="big">${Math.floor((metrics.uptimeMs || 0) / 1000 / 60)} min</div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Memory Usage</div>
            </div>
            <div class="big">${Math.floor((metrics.memUsed || 0) / 1024 / 1024)} MB</div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Devices Total</div>
            </div>
            <div class="big">${metrics.devicesTotal || 0}</div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Devices Online</div>
            </div>
            <div class="big">${metrics.devicesOnline || 0}</div>
          </div>
        </div>
      `;
    }

    // Load devices list
    async function loadDevices() {
      try {
        devices = await apiCall('/api/v1/discovery/results');
        const content = document.getElementById('devices-content');
        
        if (devices.length === 0) {
          content.innerHTML = '<div class="muted">No devices found. Run a network scan first.</div>';
          return;
        }

        content.innerHTML = devices.map(device => `
          <div class="card" style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div>
                <div style="font-weight: bold; color: var(--neon-cyan); font-size: 16px;">
                  ${device.hostname || 'Unknown Device'}
                </div>
                <div style="color: rgba(255,255,255,0.8); margin-top: 4px;">
                  ${device.ip}
                </div>
              </div>
              <div class="pill ${device.online ? 'ok' : 'bad'}">
                ${device.online ? 'Online' : 'Offline'}
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: rgba(255,255,255,0.7);">
              ${device.mac ? `<div>MAC: ${device.mac}</div>` : '<div></div>'}
              ${device.vendor ? `<div>Vendor: ${device.vendor}</div>` : '<div></div>'}
              ${device.os ? `<div>OS: ${device.os}</div>` : '<div></div>'}
              <div>Last Seen: ${new Date(device.lastSeen).toLocaleTimeString()}</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('devices-content').innerHTML = 
          '<div class="muted">Failed to load devices</div>';
      }
    }

    // Start log stream
    function startLogStream() {
      if (logStream) {
        logStream.close();
      }

      const logsContent = document.getElementById('logs-content');
      logsContent.innerHTML = '<div class="muted">Connecting to log stream...</div>';

      try {
        const url = authToken
          ? `${API_BASE}/api/v1/logs/stream?token=${encodeURIComponent(authToken)}`
          : `${API_BASE}/api/v1/logs/stream`;
        logStream = new EventSource(url);
        
        const logs = [];
        
        logStream.onmessage = function(event) {
          logs.push(event.data);
          if (logs.length > 100) logs.shift(); // Keep last 100 logs
          
          logsContent.innerHTML = logs.map(log => 
            `<div style="font-family: monospace; font-size: 12px; margin-bottom: 4px; color: var(--neon-cyan);">${log}</div>`
          ).join('');
          logsContent.scrollTop = logsContent.scrollHeight;
        };

        logStream.onerror = function() {
          logsContent.innerHTML = '<div class="muted">Log stream disconnected</div>';
        };
      } catch (error) {
        logsContent.innerHTML = '<div class="muted">Failed to connect to log stream</div>';
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tabbtn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // Update tab pages
      document.querySelectorAll('.tab-page').forEach(page => {
        page.classList.toggle('active', page.id === `tab-${tabName}`);
      });

      // Load content for specific tabs
      switch(tabName) {
        case 'devices':
          loadDevices();
          break;
        case 'metrics':
          loadMetrics();
          break;
        case 'logs':
          startLogStream();
          break;
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', async function() {
      // Authenticate on load
      await authenticate();

      // Scan button
      document.getElementById('scanBtn').addEventListener('click', scanNetwork);

      // Tab buttons
      document.querySelectorAll('.tabbtn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Initial data load
      loadDevices();
      loadMetrics();

      // Periodic updates
      setInterval(loadMetrics, 30000); // Update metrics every 30 seconds
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (logStream) {
        logStream.close();
      }
    });
  </script>
</body>
</html>
