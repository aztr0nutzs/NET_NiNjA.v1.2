<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Psycho-Engine Speedtest</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#0db9f2",
          secondary: "#a855f7",
          "background-light": "#f5f8f8",
          "background-dark": "#050a0c",
          panel: "#111c21"
        },
        fontFamily: {
          display: ["Space Grotesk", "sans-serif"]
        },
        borderRadius: {
          DEFAULT: "0.125rem",
          lg: "0.25rem",
          xl: "0.5rem",
          full: "0.75rem"
        }
      }
    }
  }
</script>
<style>
  .vhs-overlay { background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; }
  .chromatic-aberration { text-shadow: 2px 0 #ff00ff, -2px 0 #00ffff; }
  .glitch-border { box-shadow: 0 0 10px rgba(13, 185, 242, 0.3), inset 0 0 5px rgba(13, 185, 242, 0.2); }
  .nitro-shard { clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); }
  .data-heart-glow { filter: drop-shadow(0 0 15px rgba(13, 185, 242, 0.8)); }
  .log-scroll { scrollbar-width: thin; }
  body { min-height: max(884px, 100dvh); }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 overflow-hidden antialiased">
<div class="fixed inset-0 vhs-overlay z-50 mix-blend-overlay opacity-40"></div>
<div class="relative flex h-screen w-full flex-col justify-between overflow-hidden">
  <header class="flex items-center justify-between p-4 pt-8 bg-gradient-to-b from-background-dark/80 to-transparent z-10">
    <div class="flex flex-col">
      <span class="text-[10px] tracking-[0.3em] text-primary/60 font-bold">SYSTEM STATUS</span>
      <h2 class="text-primary text-sm font-bold leading-tight flex items-center gap-2">
        <span class="material-symbols-outlined text-xs">terminal</span>
        PSYCHO-ENGINE V1.0.3
      </h2>
      <div class="text-[10px] text-slate-500 mt-1" id="phaseLabel">PHASE: IDLE</div>
    </div>
    <div class="flex gap-4 items-center">
      <div class="text-right hidden sm:block">
        <p class="text-[10px] text-slate-500 uppercase">Selected Server</p>
        <p class="text-xs font-bold text-secondary" id="serverLabel">--</p>
      </div>
      <button class="size-10 rounded-full bg-primary/10 border border-primary/30 flex items-center justify-center text-primary" id="btnHeaderAction" title="Refresh / Abort">
        <span class="material-symbols-outlined" id="btnHeaderIcon">refresh</span>
      </button>
    </div>
  </header>

  <main class="relative flex-1 flex flex-col items-center justify-center px-4">
    <div class="absolute inset-0 z-0 opacity-20">
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_transparent_0%,_#050a0c_70%)] z-10"></div>
      <div class="w-full h-full bg-center bg-cover scale-110" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCZq-u9WkN5HIg-r6DbgbkFk0tVDngjoCq4_8_BDBx3wyWNCmaGxO20LTdwawL8PjRJKV_p7S-T5hpkp896wdHx_tNNWzR5Po399iz7PWgKZ8UCIu3-zxQgOpcB9oxo2_iwzayGSS04HnOFrPWGjFWQ5WdQG1tZvhOsA0mG_6jeFw2lkbNI5eZ95J1qvR3UOxrO4TupRQbqRSY71MphD1earMcsm5cJaUKoEQIT9fWSqYOG5YRzcTXfqIw3JkYXFIujgGbk_4jMAMPf');"></div>
    </div>

    <div class="relative z-10 flex flex-col items-center w-full max-w-sm">
      <div class="absolute -top-12 left-0 right-0 flex justify-between px-6 opacity-80">
        <div class="flex flex-col items-start border-l-2 border-primary pl-2">
          <span class="text-[9px] text-primary uppercase tracking-tighter">Heat Level</span>
          <span class="text-sm font-bold text-primary" id="heatLabel">IDLE</span>
        </div>
        <div class="flex flex-col items-end border-r-2 border-secondary pr-2">
          <span class="text-[9px] text-secondary uppercase tracking-tighter">Pressure</span>
          <span class="text-sm font-bold text-secondary" id="pressureLabel">STANDBY</span>
        </div>
      </div>

      <div class="relative group">
        <div class="absolute -inset-10 bg-primary/5 blur-3xl rounded-full"></div>
        <div class="size-64 sm:size-80 relative flex items-center justify-center">
          <div class="absolute inset-0 border-[1px] border-primary/20 rounded-full animate-[spin_10s_linear_infinite]"></div>
          <div class="absolute inset-4 border-[1px] border-secondary/20 rounded-full animate-[spin_15s_linear_infinite_reverse]"></div>
          <div class="relative z-20 size-48 sm:size-56 bg-panel/80 rounded-xl border-2 border-primary/40 glitch-border p-4 flex flex-col items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-[repeating-linear-gradient(0deg,transparent,transparent_2px,rgba(13,185,242,0.5)_2px,rgba(13,185,242,0.5)_4px)]"></div>
            <div class="relative z-10 flex flex-col items-center">
              <span class="text-[10px] tracking-[0.5em] text-primary/70 font-bold mb-1 italic">THROUGHPUT</span>
              <div class="flex items-baseline gap-1 chromatic-aberration">
                <span class="text-6xl sm:text-7xl font-bold text-white tracking-tighter leading-none" id="speedWhole">0</span>
                <span class="text-xl font-bold text-primary" id="speedFrac">.00</span>
              </div>
              <span class="text-lg font-bold text-primary/80 tracking-widest mt-2">Mbps</span>
              <div class="text-[10px] text-slate-400 mt-2" id="progressLabel">0%</div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 h-16 opacity-30 data-heart-glow">
              <svg class="w-full h-full text-primary" viewBox="0 0 200 100">
                <path d="M0 100 L20 40 L40 80 L60 20 L80 90 L100 10 L120 70 L140 30 L160 85 L180 45 L200 100 Z" fill="currentColor"></path>
              </svg>
            </div>
          </div>
          <div class="absolute -top-4 -right-4 size-12 bg-secondary/20 border border-secondary/50 nitro-shard flex items-center justify-center">
            <span class="material-symbols-outlined text-secondary text-sm">bolt</span>
          </div>
        </div>
      </div>

      <div class="mt-12 grid grid-cols-3 gap-3 w-full px-2">
        <div class="bg-panel/60 border-l border-primary/40 p-3">
          <p class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Latency</p>
          <p class="text-lg font-bold text-slate-100"><span id="latencyVal">--</span><span class="text-[10px] text-primary ml-1">MS</span></p>
        </div>
        <div class="bg-panel/60 border-l border-primary/40 p-3">
          <p class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Jitter</p>
          <p class="text-lg font-bold text-slate-100"><span id="jitterVal">--</span><span class="text-[10px] text-primary ml-1">MS</span></p>
        </div>
        <div class="bg-panel/60 border-l border-primary/40 p-3">
          <p class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Loss</p>
          <p class="text-lg font-bold text-slate-100"><span id="lossVal">--</span><span class="text-[10px] text-primary ml-1">%</span></p>
        </div>
      </div>
      <div class="mt-3 text-[10px] text-slate-400" id="bbLabel">BUFFERBLOAT: --</div>
    </div>
  </main>

  <footer class="p-6 pb-10 flex flex-col gap-4 z-10">
    <button class="relative w-full group overflow-hidden" id="btnStartStop" type="button">
      <div class="absolute inset-0 bg-primary/20 nitro-shard scale-105 group-hover:scale-110 transition-transform duration-300"></div>
      <div class="relative bg-primary text-background-dark font-black tracking-tighter text-xl py-5 nitro-shard flex items-center justify-center gap-3" id="btnStartStopText">
        <span class="material-symbols-outlined">speed</span>
        INITIATE NITRO SCAN
      </div>
    </button>

    <div class="max-h-24 overflow-auto bg-black/30 border border-primary/20 rounded px-3 py-2 log-scroll text-[10px] font-mono text-slate-300" id="eventLog"></div>

    <nav class="flex justify-between items-center px-4">
      <button class="flex flex-1 flex-col items-center gap-1 text-primary" id="navEngine" type="button">
        <span class="material-symbols-outlined text-2xl">offline_bolt</span>
        <span class="text-[9px] font-bold tracking-tighter">ENGINE</span>
      </button>
      <button class="flex flex-1 flex-col items-center gap-1 text-slate-500 hover:text-primary transition-colors" id="navLogs" type="button">
        <span class="material-symbols-outlined text-2xl">history</span>
        <span class="text-[9px] font-bold tracking-tighter">LOGS</span>
      </button>
      <button class="flex flex-1 flex-col items-center gap-1 text-slate-500 hover:text-primary transition-colors" id="navNodes" type="button">
        <span class="material-symbols-outlined text-2xl">map</span>
        <span class="text-[9px] font-bold tracking-tighter">NODES</span>
      </button>
      <button class="flex flex-1 flex-col items-center gap-1 text-slate-500 hover:text-primary transition-colors" id="navConfig" type="button">
        <span class="material-symbols-outlined text-2xl">settings</span>
        <span class="text-[9px] font-bold tracking-tighter">CONFIG</span>
      </button>
    </nav>
  </footer>

  <div class="absolute bottom-32 left-0 w-full flex justify-center opacity-10 pointer-events-none">
    <span class="text-[120px] font-black tracking-tighter leading-none select-none">OVERDRIVE</span>
  </div>
  <div class="absolute top-1/2 left-4 -translate-y-1/2 flex flex-col gap-1 z-0">
    <div class="h-12 w-0.5 bg-primary/30"></div>
    <div class="h-2 w-0.5 bg-secondary"></div>
    <div class="h-20 w-0.5 bg-primary/10"></div>
  </div>
  <div class="absolute top-1/2 right-4 -translate-y-1/2 flex flex-col gap-1 z-0 items-end">
    <div class="h-20 w-0.5 bg-primary/10"></div>
    <div class="h-2 w-0.5 bg-primary"></div>
    <div class="h-12 w-0.5 bg-secondary/30"></div>
  </div>
</div>

<script src="js/api-client.js"></script>
<script>
(() => {
  "use strict";

  const api = window.NetNinjaApi;
  const endpoint = {
    servers: "/api/v1/speedtest/servers",
    config: "/api/v1/speedtest/config",
    start: "/api/v1/speedtest/start",
    abort: "/api/v1/speedtest/abort",
    reset: "/api/v1/speedtest/reset",
    live: "/api/v1/speedtest/live",
    result: "/api/v1/speedtest/result",
    ping: "/api/v1/speedtest/ping",
    download: "/api/v1/speedtest/download?bytes=",
    upload: "/api/v1/speedtest/upload"
  };

  const ui = {
    speedWhole: document.getElementById("speedWhole"),
    speedFrac: document.getElementById("speedFrac"),
    phaseLabel: document.getElementById("phaseLabel"),
    progressLabel: document.getElementById("progressLabel"),
    serverLabel: document.getElementById("serverLabel"),
    heatLabel: document.getElementById("heatLabel"),
    pressureLabel: document.getElementById("pressureLabel"),
    latencyVal: document.getElementById("latencyVal"),
    jitterVal: document.getElementById("jitterVal"),
    lossVal: document.getElementById("lossVal"),
    bbLabel: document.getElementById("bbLabel"),
    btnStartStop: document.getElementById("btnStartStop"),
    btnStartStopText: document.getElementById("btnStartStopText"),
    btnHeaderAction: document.getElementById("btnHeaderAction"),
    btnHeaderIcon: document.getElementById("btnHeaderIcon"),
    eventLog: document.getElementById("eventLog"),
    navEngine: document.getElementById("navEngine"),
    navLogs: document.getElementById("navLogs"),
    navNodes: document.getElementById("navNodes"),
    navConfig: document.getElementById("navConfig")
  };

  const state = {
    running: false,
    aborted: false,
    config: { serverId: "neo-1", realMode: true, precisionRange: false },
    live: { phase: "IDLE", progress: 0 },
    pingSamples: [],
    downloadMbps: 0,
    uploadMbps: 0,
    pollTimer: null,
    log: []
  };

  function addLog(message) {
    const ts = new Date().toLocaleTimeString();
    state.log.unshift(`[${ts}] ${message}`);
    state.log = state.log.slice(0, 40);
    ui.eventLog.innerHTML = state.log.map((line) => `<div>${escapeHtml(line)}</div>`).join("");
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>\"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]));
  }

  function fmt(v, d = 2) {
    if (v == null || Number.isNaN(Number(v))) return "--";
    return Number(v).toFixed(d);
  }

  function setSpeed(v) {
    const n = Math.max(0, Number(v) || 0);
    const fixed = n.toFixed(2).split(".");
    ui.speedWhole.textContent = fixed[0];
    ui.speedFrac.textContent = `.${fixed[1]}`;
  }

  function setPhase(phase, progress) {
    const p = Number(progress) || 0;
    ui.phaseLabel.textContent = `PHASE: ${String(phase || "IDLE").toUpperCase()}`;
    ui.progressLabel.textContent = `${Math.max(0, Math.min(100, Math.round(p)))}%`;
    const phaseNorm = String(phase || "").toUpperCase();
    ui.heatLabel.textContent = phaseNorm === "DOWNLOAD" || phaseNorm === "UPLOAD" ? "CRITICAL" : (phaseNorm === "PING" ? "WARM" : "IDLE");
    ui.pressureLabel.textContent = phaseNorm === "COMPLETE" ? "STABLE" : (phaseNorm === "ABORTED" ? "ABORTED" : (phaseNorm === "ERROR" ? "ERROR" : "ACTIVE"));
  }

  function setRunning(running) {
    state.running = !!running;
    ui.btnHeaderIcon.textContent = state.running ? "close" : "refresh";
    ui.btnStartStopText.innerHTML = state.running
      ? '<span class="material-symbols-outlined">close</span>ABORT NITRO SCAN'
      : '<span class="material-symbols-outlined">speed</span>INITIATE NITRO SCAN';
  }

  function calcStd(arr) {
    if (!arr.length) return null;
    const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
    const variance = arr.reduce((a, b) => a + (b - mean) * (b - mean), 0) / Math.max(1, arr.length - 1);
    return Math.sqrt(variance);
  }

  async function refreshConfig() {
    const [servers, config] = await Promise.all([
      api.fetchJson(endpoint.servers, { cache: "no-store", timeoutMs: 5000 }),
      api.fetchJson(endpoint.config, { cache: "no-store", timeoutMs: 5000 })
    ]);
    if (config && typeof config === "object") state.config = { ...state.config, ...config };
    const selected = Array.isArray(servers) ? servers.find((s) => s.id === state.config.serverId) : null;
    ui.serverLabel.textContent = selected ? selected.name : (state.config.serverId || "--");
  }

  async function pollLive() {
    if (state.pollTimer) clearInterval(state.pollTimer);
    state.pollTimer = setInterval(async () => {
      try {
        const live = await api.fetchJson(endpoint.live, { cache: "no-store", timeoutMs: 5000 });
        if (!live || typeof live !== "object") return;
        state.live = live;
        setPhase(live.phase || "IDLE", live.progress || 0);
        if (live.pingMs != null) ui.latencyVal.textContent = fmt(live.pingMs, 0);
        if (live.jitterMs != null) ui.jitterVal.textContent = fmt(live.jitterMs, 1);
        if (live.lossPct != null) ui.lossVal.textContent = fmt(live.lossPct, 1);
        if (live.bufferbloat) ui.bbLabel.textContent = `BUFFERBLOAT: ${String(live.bufferbloat).toUpperCase()}`;
        const activeSpeed = Number(live.uploadMbps ?? live.downloadMbps ?? 0);
        setSpeed(activeSpeed);
        if (!live.running && ["COMPLETE", "ABORTED", "ERROR", "IDLE"].includes(String(live.phase || "").toUpperCase())) {
          setRunning(false);
        }
      } catch (_) {}
    }, 400);
  }

  async function measurePing() {
    state.pingSamples = [];
    for (let i = 0; i < 6; i += 1) {
      if (state.aborted) throw new Error("aborted");
      const t0 = performance.now();
      await api.fetchJson(`${endpoint.ping}?t=${Math.random().toString(16).slice(2)}`, { cache: "no-store", timeoutMs: 6000 });
      const dt = performance.now() - t0;
      state.pingSamples.push(dt);
      ui.latencyVal.textContent = fmt(dt, 0);
      ui.jitterVal.textContent = fmt(calcStd(state.pingSamples), 1);
      setPhase("PING", 5 + ((i + 1) / 6) * 20);
    }
    const avg = state.pingSamples.reduce((a, b) => a + b, 0) / state.pingSamples.length;
    const jitter = calcStd(state.pingSamples);
    await api.fetchJson(endpoint.result, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ running: true, phase: "PING", progress: 25, pingMs: avg, jitterMs: jitter })
    });
    return { ping: avg, jitter };
  }

  async function measureDownload(bytes) {
    const url = `${endpoint.download}${encodeURIComponent(bytes)}&t=${Math.random().toString(16).slice(2)}`;
    const res = await fetch(api.resolveApiUrl(url), {
      cache: "no-store",
      headers: {
        Accept: "application/octet-stream",
        ...(api.token ? { Authorization: `Bearer ${api.token}` } : {})
      }
    });
    if (!res.ok || !res.body) throw new Error(`download_failed_${res.status}`);

    const reader = res.body.getReader();
    const start = performance.now();
    let received = 0;

    while (true) {
      if (state.aborted) throw new Error("aborted");
      const { done, value } = await reader.read();
      if (done) break;
      received += value.byteLength;
      const elapsed = Math.max(1, performance.now() - start);
      const mbps = (received * 8) / (elapsed / 1000) / 1000000;
      state.downloadMbps = mbps;
      setSpeed(mbps);
      setPhase("DOWNLOAD", 25 + Math.min(55, (received / bytes) * 55));
    }

    await api.fetchJson(endpoint.result, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ running: true, phase: "DOWNLOAD", progress: 80, downloadMbps: state.downloadMbps })
    });
  }

  async function measureUpload(bytes) {
    const payload = new Uint8Array(bytes);
    for (let i = 0; i < payload.length; i += 1) payload[i] = i % 256;

    const t0 = performance.now();
    const res = await fetch(api.resolveApiUrl(endpoint.upload), {
      method: "POST",
      headers: {
        "Content-Type": "application/octet-stream",
        ...(api.token ? { Authorization: `Bearer ${api.token}` } : {})
      },
      body: payload
    });
    if (!res.ok) throw new Error(`upload_failed_${res.status}`);
    const data = await res.json();
    const elapsed = Math.max(1, performance.now() - t0);
    state.uploadMbps = Number(data.uploadMbps || (bytes * 8) / (elapsed / 1000) / 1000000);
    setSpeed(state.uploadMbps);
    setPhase("UPLOAD", 95);
  }

  function computeLossAndBloat(ping, jitter) {
    const loss = Math.max(0, Math.min(5, (Number(jitter || 0) / 20) + (Number(ping || 0) / 150)));
    let bloat = "low";
    if (jitter > 8 || ping > 35) bloat = "med";
    if (jitter > 20 || ping > 80) bloat = "high";
    return { loss, bloat };
  }

  async function startTest() {
    state.aborted = false;
    setRunning(true);
    addLog("Speedtest start requested");

    await api.fetchJson(endpoint.start, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        serverId: state.config.serverId,
        realMode: true,
        precisionRange: !!state.config.precisionRange
      })
    });

    const { ping, jitter } = await measurePing();
    await measureDownload(20000000);
    await measureUpload(8000000);

    const { loss, bloat } = computeLossAndBloat(ping, jitter);
    ui.lossVal.textContent = fmt(loss, 1);
    ui.bbLabel.textContent = `BUFFERBLOAT: ${String(bloat).toUpperCase()}`;

    await api.fetchJson(endpoint.result, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        running: false,
        phase: "COMPLETE",
        progress: 100,
        serverId: state.config.serverId,
        pingMs: ping,
        jitterMs: jitter,
        downloadMbps: state.downloadMbps,
        uploadMbps: state.uploadMbps,
        lossPct: loss,
        bufferbloat: bloat,
        error: null
      })
    });

    setPhase("COMPLETE", 100);
    addLog(`Complete: DL ${fmt(state.downloadMbps, 2)} Mbps / UL ${fmt(state.uploadMbps, 2)} Mbps`);
    setRunning(false);
  }

  async function abortTest() {
    state.aborted = true;
    await api.fetchJson(endpoint.abort, { method: "POST" });
    setPhase("ABORTED", state.live.progress || 0);
    addLog("Speedtest aborted");
    setRunning(false);
  }

  async function resetTest() {
    await api.fetchJson(endpoint.reset, { method: "POST" });
    setSpeed(0);
    ui.latencyVal.textContent = "--";
    ui.jitterVal.textContent = "--";
    ui.lossVal.textContent = "--";
    ui.bbLabel.textContent = "BUFFERBLOAT: --";
    setPhase("IDLE", 0);
    addLog("Speedtest state reset");
    await refreshConfig();
  }

  function wireNav() {
    ui.navEngine?.addEventListener("click", () => refreshConfig().then(() => addLog("Engine config refreshed")).catch(() => addLog("Engine refresh failed")));
    ui.navLogs?.addEventListener("click", () => api.fetchJson("/api/v1/system/state", { cache: "no-store", timeoutMs: 5000 })
      .then((st) => addLog(`System state phase: ${st?.scanProgress?.phase || "n/a"}`))
      .catch(() => addLog("System state unavailable")));
    ui.navNodes?.addEventListener("click", () => {
      try {
        const btn = window.parent?.document?.getElementById("tabbtn-networks");
        if (btn) { btn.click(); addLog("Switched to nodes tab"); return; }
      } catch (_) {}
      addLog("Nodes tab handoff unavailable");
    });
    ui.navConfig?.addEventListener("click", () => {
      try {
        const btn = window.parent?.document?.getElementById("settingsBtn");
        if (btn) { btn.click(); addLog("Opened settings"); return; }
      } catch (_) {}
      addLog("Settings handoff unavailable");
    });
  }

  function wireActions() {
    ui.btnStartStop?.addEventListener("click", async () => {
      try {
        if (state.running) {
          await abortTest();
        } else {
          await startTest();
        }
      } catch (e) {
        addLog(`Speedtest error: ${e && e.message ? e.message : "unknown"}`);
        await api.fetchJson(endpoint.result, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ running: false, phase: "ERROR", progress: state.live.progress || 0, error: String(e && e.message ? e.message : "error") })
        }).catch(() => {});
        setRunning(false);
        setPhase("ERROR", state.live.progress || 0);
      }
    });

    ui.btnHeaderAction?.addEventListener("click", () => {
      if (state.running) {
        abortTest().catch(() => addLog("Abort failed"));
      } else {
        resetTest().catch(() => addLog("Reset failed"));
      }
    });
  }

  async function init() {
    wireActions();
    wireNav();
    addLog("Speedtest UI online");
    await refreshConfig();
    await resetTest();
    await pollLive();
  }

  init().catch((e) => addLog(`Init failed: ${e && e.message ? e.message : "unknown"}`));
})();
</script>
</body>
</html>
